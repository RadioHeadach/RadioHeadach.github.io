<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- iOS Safari -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- Chrome, Firefox OS and Opera Status Bar Color -->
  <meta name="theme-color" content="#FFFFFF">
  <meta property="og:title" content="WKWebView拦截特定加载协议">
    <meta name="description" content="通过 hook 私有方法来让 WKWebView 获得拦截私有 scheme 的能力">
  <meta property="og:description" content="通过 hook 私有方法来让 WKWebView 获得拦截私有 scheme 的能力">
    <meta property="og:type" content="blog">
  <title>WKWebView拦截特定加载协议</title>
  <!-- Favicon -->
    <link rel="shortcut icon" href="〽️">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
  <link rel="stylesheet" type="text/css"
    href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
  <link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
  <link rel="stylesheet" type="text/css" href="css/notablog.css">
  <link rel="stylesheet" type="text/css" href="css/theme.css">
  <style>
    :root {
      font-size: 18px;
    }

    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
    <a href="index.html">
      <div class="Navbar__Btn"><span>〽️</span> <span>Home</span></div>
    </a>
                    <span class="Navbar__Delim">&centerdot;</span>
    <a href="iOS-Dev-Articles.html">
      <div class="Navbar__Btn"> <span>📱iOS Articles</span></div>
    </a>
                                                                                                <span class="Navbar__Delim">&centerdot;</span>
    <a href="about.html">
      <div class="Navbar__Btn"><span>😀</span> <span>About</span></div>
    </a>
                          </nav>
  <header class="Header">
          <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
        <h1 class="Header__Title">WKWebView拦截特定加载协议</h1>
            <div class="DateTagBar">
                <span class="DateTagBar__Item DateTagBar__Date">Posted on Fri, May 14, 2021</span>
                          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--red">
            <a href="tag/iOS-Dev.html">iOS-Dev</a>
          </span>
                <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--orange">
            <a href="tag/WKWebView.html">WKWebView</a>
          </span>
                  </div>
          </header>
      <article id="https://www.notion.so/35da67de128046aa9ef10e4d8152ed1c" class="PageRoot"><ul id="https://www.notion.so/344cc4de0ff442378a93c71f5de2edf2" class="ColorfulBlock ColorfulBlock--ColorGray TableOfContents"><li class="TableOfContents__Item"><a href="#https://www.notion.so/5bcbf5e1da934bf6aaba61e5d583fbeb"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">After iOS 11 - WKURLSchemeHandler</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/9e701989be0447efbf1701e2cde8c9e1"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">1. 设定 handler</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/cddf01aaf8e04d0d8cb4a1110d8274f1"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">2. override 回调，通过NSURLResponse返回Data</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/ef81de3648e54f6899550e701c83cba5"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">iOS 10 and below</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/9013815cd09741ffa40411ba8b5bdb03"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">技术背景</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/2a76c8075d1e4512a72ff6398b6d5ec1"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">方案来源</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/938fd55176144528b6e57c83c2e0bda1"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">实现方案</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/3cac55933c8144fc8eb0e12557cdbcfa"><div style="margin-left:48px"><span class="SemanticStringArray"><span class="SemanticString">1. AppDelegate内注册</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/0b3e8c0f0e2c438b9e00e0c654abb1aa"><div style="margin-left:48px"><span class="SemanticStringArray"><span class="SemanticString">2. </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">InterceptionNSURLProtocol</code></span><span class="SemanticString"> 类</span></span></div></a></li></ul><h1 id="https://www.notion.so/5bcbf5e1da934bf6aaba61e5d583fbeb" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/5bcbf5e1da934bf6aaba61e5d583fbeb"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">After iOS 11 - WKURLSchemeHandler</span></span></h1><div id="https://www.notion.so/e717f6b1946d4edb98f64321c4c707b0" class="Bookmark"><a href="https://developer.apple.com/videos/play/wwdc2017/220/"><h5 class="Bookmark__Title">Customized Loading in WKWebView - WWDC 2017 - Videos - Apple Developer</h5><p class="Bookmark__Desc">WKWebView allows you to seamlessly integrate web content into your app. Learn how new features in WKWebView allow you to manage cookies,...</p><p class="Bookmark__Link">https://developer.apple.com/videos/play/wwdc2017/220/</p></a></div><div id="https://www.notion.so/e2305ea1a12644bb89a368f1dd3f277f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">iOS 11 之后，苹果为 WKWebView 推出 WKURLSchemeHandler 的回调方法，在 web 请求资源的时候，如果使用了 non-standard 非正式的 scheme，都可以被拦截，并通过回调通知。</span></span></p></div><h2 id="https://www.notion.so/9e701989be0447efbf1701e2cde8c9e1" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/9e701989be0447efbf1701e2cde8c9e1"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">1. 设定 handler</span></span></h2><pre id="https://www.notion.so/de3cb33c9a82476aaf42cf283835025a" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token operator">-</span> <span class="token punctuation">(</span>WKWebView <span class="token operator">*</span><span class="token punctuation">)</span>webView <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_webView <span class="token operator">==</span> nil<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        WKWebViewConfiguration <span class="token operator">*</span>configuration <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>WKWebViewConfiguration alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">@</span><span class="token function">available</span><span class="token punctuation">(</span>iOS <span class="token number">11.0</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            </span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedBg SemanticString__Fragment--BgPink"><span><span class="token punctuation">[</span>configuration setURLSchemeHandler<span class="token punctuation">:</span><span class="token keyword">self</span> forURLScheme<span class="token punctuation">:</span><span class="token string">@"img"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</span></mark></span><span class="SemanticString"><span>						</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedBg SemanticString__Fragment--BgPink"><span><span class="token comment">// 设定自定义的 scheme</span></span></mark></span><span class="SemanticString"><span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// Fallback on earlier versions</span>
        <span class="token punctuation">}</span>
        _webView <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>WKWebView alloc<span class="token punctuation">]</span> initWithFrame<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>view frame<span class="token punctuation">]</span> configuration<span class="token punctuation">:</span>configuration<span class="token punctuation">]</span><span class="token punctuation">;</span>
        _webView<span class="token punctuation">.</span>navigationDelegate <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">;</span>
        _webView<span class="token punctuation">.</span>UIDelegate <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> _webView<span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></span></span></code></pre><h2 id="https://www.notion.so/cddf01aaf8e04d0d8cb4a1110d8274f1" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/cddf01aaf8e04d0d8cb4a1110d8274f1"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">2. override 回调，通过NSURLResponse返回Data</span></span></h2><pre id="https://www.notion.so/21a3541f74ab427ab5cc8080ef32ad0d" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">mark <span class="token operator">-</span> WKURLSchemeHandler</span></span>

<span class="token comment">/*! @abstract Notifies your app to start loading the data for a particular resource
 represented by the URL scheme handler task.
 @param webView The web view invoking the method.
 @param urlSchemeTask The task that your app should start loading data for.
 */</span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>webView<span class="token punctuation">:</span><span class="token punctuation">(</span>WKWebView <span class="token operator">*</span><span class="token punctuation">)</span>webView startURLSchemeTask<span class="token punctuation">:</span><span class="token punctuation">(</span>id <span class="token operator">&lt;</span>WKURLSchemeTask<span class="token operator">></span><span class="token punctuation">)</span>urlSchemeTask  <span class="token function">API_AVAILABLE</span><span class="token punctuation">(</span><span class="token function">ios</span><span class="token punctuation">(</span><span class="token number">11.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    NSURL <span class="token operator">*</span>requestURL <span class="token operator">=</span> urlSchemeTask<span class="token punctuation">.</span>request<span class="token punctuation">.</span>URL<span class="token punctuation">;</span>
    NSString <span class="token operator">*</span>filter <span class="token operator">=</span> <span class="token punctuation">[</span>NSString stringWithFormat<span class="token punctuation">:</span><span class="token string">@"img"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span>requestURL<span class="token punctuation">.</span>absoluteString containsString<span class="token punctuation">:</span>filter<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    UIImage <span class="token operator">*</span>image <span class="token operator">=</span> <span class="token punctuation">[</span>UIImage imageNamed<span class="token punctuation">:</span>requestURL<span class="token punctuation">.</span>lastPathComponent<span class="token punctuation">]</span><span class="token punctuation">;</span>
    NSData <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token function">UIImageJPEGRepresentation</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    NSURLResponse <span class="token operator">*</span>response <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSURLResponse alloc<span class="token punctuation">]</span> initWithURL<span class="token punctuation">:</span>urlSchemeTask<span class="token punctuation">.</span>request<span class="token punctuation">.</span>URL MIMEType<span class="token punctuation">:</span><span class="token string">@"image/jpeg"</span> expectedContentLength<span class="token punctuation">:</span>data<span class="token punctuation">.</span>length textEncodingName<span class="token punctuation">:</span>nil<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>urlSchemeTask didReceiveResponse<span class="token punctuation">:</span>response<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>urlSchemeTask didReceiveData<span class="token punctuation">:</span>data<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>urlSchemeTask didFinish<span class="token punctuation">]</span><span class="token punctuation">;</span>    
<span class="token punctuation">}</span>

<span class="token comment">/*! @abstract Notifies your app to stop handling a URL scheme handler task.
 @param webView The web view invoking the method.
 @param urlSchemeTask The task that your app should stop handling.
 @discussion After your app is told to stop loading data for a URL scheme handler task
 it must not perform any callbacks for that task.
 An exception will be thrown if any callbacks are made on the URL scheme handler task
 after your app has been told to stop loading for it.
 */</span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>webView<span class="token punctuation">:</span><span class="token punctuation">(</span>WKWebView <span class="token operator">*</span><span class="token punctuation">)</span>webView stopURLSchemeTask<span class="token punctuation">:</span><span class="token punctuation">(</span>id <span class="token operator">&lt;</span>WKURLSchemeTask<span class="token operator">></span><span class="token punctuation">)</span>urlSchemeTask  <span class="token function">API_AVAILABLE</span><span class="token punctuation">(</span><span class="token function">ios</span><span class="token punctuation">(</span><span class="token number">11.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
<span class="token punctuation">}</span></span></span></span></code></pre><h1 id="https://www.notion.so/ef81de3648e54f6899550e701c83cba5" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/ef81de3648e54f6899550e701c83cba5"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">iOS 10 and below</span></span></h1><h2 id="https://www.notion.so/9013815cd09741ffa40411ba8b5bdb03" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/9013815cd09741ffa40411ba8b5bdb03"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">技术背景</span></span></h2><div id="https://www.notion.so/73b4d6d4bb2e4356bc24b94bb1143e86" class="Bookmark"><a href="https://www.jianshu.com/p/55f5ac1ab817"><h5 class="Bookmark__Title">WKWebView 不支持 NSURLProtocol 吗</h5><p class="Bookmark__Desc">前段时间总结过《WKWebView从入门到趟坑》，其中提到 NSURLProtocol 拦截支持和缓存的痛点。在 UIWebView 时代，按照下面的方式注册一个自定义的 NSURLProtocol 和 CustomURLCache 的子类， // 注册url拦截 [NSURLProtocol registerClass:[CustomURLProtocol class]]; // 注册缓存加载 [NSURLCache setSharedURLCache:[CustomURLCache new]]; 然后就可以在其实现中对 app 内所有的网络请求进行拦截，并加载本地的离线资源（很多 Hybird 框架都是基于此原理）。但在 WKWebView 中的请求却完全不遵从这一规则，网络上文章一般都解释说 WKWebView 的请求是在单独的进程里，所以不走 NSURLProtocol。 断点调用栈也显示 WKWebView 在加载 page 时候的确使用的是 WebKit 的 IPC 消息收发/分发机制 MessageQueue 进行进程之间的通信，但也发现它竟然调用到了 + [NSURLProtocol canInitWithRequest:] 之后的流程就不在执行 NSURLProtocol 相关的方法了，既然调用了一个 canInitWithRequest，至少说明 WKWebView 还是引用了 NSURLProtocol</p><p class="Bookmark__Link">https://www.jianshu.com/p/55f5ac1ab817</p></a></div><div id="https://www.notion.so/2f90e4ee02a54540a08e8433b9d62a16" class="Bookmark"><a href="https://zhuanlan.zhihu.com/p/24990222"><h5 class="Bookmark__Title">WKWebView 那些坑</h5><p class="Bookmark__Desc">本文来自于 腾讯Bugly公众号（weixinBugly），未经作者同意，请勿转载，原文地址：WKWebView 那些坑 导语 WKWebView 是苹果在 WWDC 2014 上推出的新一代 webView 组件，用以替代 UIKit 中笨重难用、内存泄漏的 UIW...</p><p class="Bookmark__Link">https://zhuanlan.zhihu.com/p/24990222</p></a></div><div id="https://www.notion.so/d32b7e1533c74c2cbd7c19b37e187a3d" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">💡</div></div><p class="Callout__Content"><span class="SemanticStringArray"><span class="SemanticString">WKWebView 在独立于 app 进程之外的进程中执行网络请求，请求数据不经过主进程，因此，在 WKWebView 上直接使用 NSURLProtocol 无法拦截请求。</span></span></p></div><h2 id="https://www.notion.so/2a76c8075d1e4512a72ff6398b6d5ec1" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/2a76c8075d1e4512a72ff6398b6d5ec1"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">方案来源</span></span></h2><div id="https://www.notion.so/3b9072391d374ff8b512ca72a3b7883d" class="Bookmark"><a href="https://github.com/LiuShuoyu/HybirdWKWebVIew"><h5 class="Bookmark__Title">LiuShuoyu/HybirdWKWebVIew</h5><p class="Bookmark__Desc">一个基于WKWebView的hybirde的容器。能拦截所有WKWKWebView的的css,js,png等网络请求的demo NSURLProtocol 子类，就可以对 app 内所有的网络请求进行: 可是在 WKWebView 中的请求却完全不遵从这一规则，只是象征性+ (BOOL) canInitWithRequest:(NSURLRequest *)request 方法，之后的整个请求流程似乎就与 NSURLProtocol 完全无关了。 使我WKWebView 的一度认为请求不遵守NSURLProtocol协议，所以不走 NSURLProtocol。这个也是很苦扰我的问题。导致我们hybird的容器1.0也是是用UIWebVIew实现的。 但在苹果放在gittub的CustomHTTPProtocol，明显感觉到WKWebview的也是遵守NSURLProtocol，要不也不会走+ (BOOL)canInitWithRequest:(NSURLRequest *)request;后来一个每天看博客和gittub的习惯帮助了我，找到一个大神的不久前开源库。 使用了WKBrowsingContextController和registerSchemeForCustomProtocol。 通过反射的方式拿到了私有的 class/selector。通过kvc取到browsingContextController。通过把注册把 http 和 https 请求交给 NSURLProtocol 处理 下面直接上源代码吧 注册后，客户端所有请求走+ (BOOL)canInitWithRequest:(NSURLRequest *)request。下面是打印的请求的log request的重写定向，request的重写定向，替换百度知道的log 这里最好加上缓存判断，加载本地离线文件， 这个直接简单的例子。 下面是代码效果图 ##有问题反馈 在使用中有任何问题，欢迎反馈给我，可以用以下联系方式跟我交流 ###接受启发的作者的github github： Yeatse CC 苹果开发者文档： apple</p><p class="Bookmark__Link">https://github.com/LiuShuoyu/HybirdWKWebVIew</p></a></div><div id="https://www.notion.so/159e14fd0db3443b990ee1c10a1cd52a" class="Bookmark"><a href="https://github.com/madaoCN/WKWebViewHook"><h5 class="Bookmark__Title">madaoCN/WKWebViewHook</h5><p class="Bookmark__Desc">hook WKWebViewHook request with NSURLProtocol. Contribute to madaoCN/WKWebViewHook development by creating an account on GitHub.</p><p class="Bookmark__Link">https://github.com/madaoCN/WKWebViewHook</p></a></div><h2 id="https://www.notion.so/938fd55176144528b6e57c83c2e0bda1" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/938fd55176144528b6e57c83c2e0bda1"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">实现方案</span></span></h2><h3 id="https://www.notion.so/3cac55933c8144fc8eb0e12557cdbcfa" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/3cac55933c8144fc8eb0e12557cdbcfa"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">1. AppDelegate内注册</span></span></h3><pre id="https://www.notion.so/bb4c6e2d46eb430088c84b6a1a0e4815" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token operator">-</span> <span class="token punctuation">(</span>BOOL<span class="token punctuation">)</span>application<span class="token punctuation">:</span><span class="token punctuation">(</span>UIApplication <span class="token operator">*</span><span class="token punctuation">)</span>application didFinishLaunchingWithOptions<span class="token punctuation">:</span><span class="token punctuation">(</span>NSDictionary <span class="token operator">*</span><span class="token punctuation">)</span>launchOptions <span class="token punctuation">{</span>
	<span class="token comment">// 防止苹果静态检查 将 WKBrowsingContextController 拆分，然后再拼凑起来</span>
	NSArray <span class="token operator">*</span>privateStrArr <span class="token operator">=</span> <span class="token operator">@</span><span class="token punctuation">[</span><span class="token string">@"Controller"</span><span class="token punctuation">,</span> <span class="token string">@"Context"</span><span class="token punctuation">,</span> <span class="token string">@"Browsing"</span><span class="token punctuation">,</span> <span class="token string">@"K"</span><span class="token punctuation">,</span> <span class="token string">@"W"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	NSString <span class="token operator">*</span>className <span class="token operator">=</span>  <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">[</span>privateStrArr reverseObjectEnumerator<span class="token punctuation">]</span> allObjects<span class="token punctuation">]</span> componentsJoinedByString<span class="token punctuation">:</span><span class="token string">@""</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	Class cls <span class="token operator">=</span> <span class="token function">NSClassFromString</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
	SEL sel <span class="token operator">=</span> <span class="token function">NSSelectorFromString</span><span class="token punctuation">(</span><span class="token string">@"registerSchemeForCustomProtocol:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">if</span> <span class="token punctuation">(</span>cls <span class="token operator">&amp;&amp;</span> sel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>cls respondsToSelector<span class="token punctuation">:</span>sel<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	        <span class="token comment">// 注册http协议</span>
	<span class="token comment">//                [(id)cls performSelector:sel withObject:@"http"];</span>
	        <span class="token comment">// 注册https协议</span>
	<span class="token comment">//                [(id)cls performSelector:sel withObject:@"https"];</span>
	        <span class="token comment">// 注册 img 协议</span>
	        <span class="token punctuation">[</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>cls performSelector<span class="token punctuation">:</span>sel withObject<span class="token punctuation">:</span><span class="token string">@"img"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token punctuation">[</span>NSURLProtocol registerClass<span class="token punctuation">:</span><span class="token punctuation">[</span>InterceptionNSURLProtocol class<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></span></span></code></pre><h3 id="https://www.notion.so/0b3e8c0f0e2c438b9e00e0c654abb1aa" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/0b3e8c0f0e2c438b9e00e0c654abb1aa"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">2. </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">InterceptionNSURLProtocol</code></span><span class="SemanticString"> 类</span></span></h3><pre id="https://www.notion.so/4b562ae7de0140a3a9df585f8b0d98a8" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">import</span> <span class="token string">"InterceptionNSURLProtocol.h"</span></span>

<span class="token keyword">static</span> NSString<span class="token operator">*</span> <span class="token keyword">const</span> KHybridNSURLProtocolHKey <span class="token operator">=</span> <span class="token string">@"KHybridNSURLProtocol"</span><span class="token punctuation">;</span>

<span class="token keyword">@interface</span> <span class="token function">InterceptionNSURLProtocol</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span>NSURLSessionDelegate<span class="token operator">></span>
<span class="token keyword">@property</span> <span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> strong<span class="token punctuation">)</span> NSURLSessionDataTask <span class="token operator">*</span>task<span class="token punctuation">;</span>
<span class="token keyword">@end</span>

<span class="token keyword">@implementation</span> InterceptionNSURLProtocol
<span class="token operator">+</span> <span class="token punctuation">(</span>BOOL<span class="token punctuation">)</span>canInitWithRequest<span class="token punctuation">:</span><span class="token punctuation">(</span>NSURLRequest <span class="token operator">*</span><span class="token punctuation">)</span>request <span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@"request.URL.absoluteString = %@"</span><span class="token punctuation">,</span>request<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>absoluteString<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NSString <span class="token operator">*</span>scheme <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>request URL<span class="token punctuation">]</span> scheme<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token comment">// 进行拦截的判断</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>scheme caseInsensitiveCompare<span class="token punctuation">:</span><span class="token string">@"img"</span><span class="token punctuation">]</span>  <span class="token operator">==</span> NSOrderedSame<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//看看是否已经处理过了，防止无限循环</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>NSURLProtocol propertyForKey<span class="token punctuation">:</span>KHybridNSURLProtocolHKey inRequest<span class="token punctuation">:</span>request<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> NO<span class="token punctuation">;</span>
        <span class="token keyword">return</span> YES<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> NO<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">+</span> <span class="token punctuation">(</span>NSURLRequest <span class="token operator">*</span><span class="token punctuation">)</span>canonicalRequestForRequest<span class="token punctuation">:</span><span class="token punctuation">(</span>NSURLRequest <span class="token operator">*</span><span class="token punctuation">)</span>request
<span class="token punctuation">{</span>
    NSMutableURLRequest <span class="token operator">*</span>mutableReqeust <span class="token operator">=</span> <span class="token punctuation">[</span>request mutableCopy<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token comment">//request截取重定向</span>
<span class="token comment">//    if ([request.URL.absoluteString isEqualToString:sourUrl])</span>
<span class="token comment">//    {</span>
<span class="token comment">//        NSURL* url1 = [NSURL URLWithString:localUrl];</span>
<span class="token comment">//        mutableReqeust = [NSMutableURLRequest requestWithURL:url1];</span>
<span class="token comment">//    }</span>
    
    <span class="token keyword">return</span> mutableReqeust<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">+</span> <span class="token punctuation">(</span>BOOL<span class="token punctuation">)</span>requestIsCacheEquivalent<span class="token punctuation">:</span><span class="token punctuation">(</span>NSURLRequest <span class="token operator">*</span><span class="token punctuation">)</span>a toRequest<span class="token punctuation">:</span><span class="token punctuation">(</span>NSURLRequest <span class="token operator">*</span><span class="token punctuation">)</span>b
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token keyword">super</span> requestIsCacheEquivalent<span class="token punctuation">:</span>a toRequest<span class="token punctuation">:</span>b<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>startLoading
<span class="token punctuation">{</span>
    NSMutableURLRequest <span class="token operator">*</span>mutableReqeust <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token keyword">self</span> request<span class="token punctuation">]</span> mutableCopy<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//给我们处理过的请求设置一个标识符, 防止无限循环,</span>
    <span class="token punctuation">[</span>NSURLProtocol setProperty<span class="token punctuation">:</span><span class="token operator">@</span>YES forKey<span class="token punctuation">:</span>KHybridNSURLProtocolHKey inRequest<span class="token punctuation">:</span>mutableReqeust<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token comment">//这里最好加上缓存判断，加载本地离线文件， 这个直接简单的例子。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>mutableReqeust<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>absoluteString isEqualToString<span class="token punctuation">:</span><span class="token operator">@</span>"img<span class="token punctuation">:</span><span class="token comment">//123123"])</span>
    <span class="token punctuation">{</span>
            NSData<span class="token operator">*</span> data <span class="token operator">=</span> <span class="token function">UIImagePNGRepresentation</span><span class="token punctuation">(</span><span class="token punctuation">[</span>UIImage imageNamed<span class="token punctuation">:</span><span class="token string">@"icon"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            NSURLResponse<span class="token operator">*</span> response <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSURLResponse alloc<span class="token punctuation">]</span> initWithURL<span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">.</span>request<span class="token punctuation">.</span>URL MIMEType<span class="token punctuation">:</span><span class="token string">@"image/png"</span> expectedContentLength<span class="token punctuation">:</span>data<span class="token punctuation">.</span>length textEncodingName<span class="token punctuation">:</span>nil<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>client URLProtocol<span class="token punctuation">:</span><span class="token keyword">self</span> didReceiveResponse<span class="token punctuation">:</span>response cacheStoragePolicy<span class="token punctuation">:</span>NSURLCacheStorageAllowed<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>client URLProtocol<span class="token punctuation">:</span><span class="token keyword">self</span> didLoadData<span class="token punctuation">:</span>data<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>client URLProtocolDidFinishLoading<span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        NSURLSession <span class="token operator">*</span>session <span class="token operator">=</span> <span class="token punctuation">[</span>NSURLSession sessionWithConfiguration<span class="token punctuation">:</span><span class="token punctuation">[</span>NSURLSessionConfiguration defaultSessionConfiguration<span class="token punctuation">]</span> delegate<span class="token punctuation">:</span><span class="token keyword">self</span> delegateQueue<span class="token punctuation">:</span>nil<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>task <span class="token operator">=</span> <span class="token punctuation">[</span>session dataTaskWithRequest<span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">.</span>request<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>task resume<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>stopLoading
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>task <span class="token operator">!=</span> nil<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>task  cancel<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>URLSession<span class="token punctuation">:</span><span class="token punctuation">(</span>NSURLSession <span class="token operator">*</span><span class="token punctuation">)</span>session dataTask<span class="token punctuation">:</span><span class="token punctuation">(</span>NSURLSessionDataTask <span class="token operator">*</span><span class="token punctuation">)</span>dataTask didReceiveResponse<span class="token punctuation">:</span><span class="token punctuation">(</span>NSURLResponse <span class="token operator">*</span><span class="token punctuation">)</span>response completionHandler<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>NSURLSessionResponseDisposition<span class="token punctuation">)</span><span class="token punctuation">)</span>completionHandler <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token keyword">self</span> client<span class="token punctuation">]</span> URLProtocol<span class="token punctuation">:</span><span class="token keyword">self</span> didReceiveResponse<span class="token punctuation">:</span>response cacheStoragePolicy<span class="token punctuation">:</span>NSURLCacheStorageAllowed<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token function">completionHandler</span><span class="token punctuation">(</span>NSURLSessionResponseAllow<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>URLSession<span class="token punctuation">:</span><span class="token punctuation">(</span>NSURLSession <span class="token operator">*</span><span class="token punctuation">)</span>session dataTask<span class="token punctuation">:</span><span class="token punctuation">(</span>NSURLSessionDataTask <span class="token operator">*</span><span class="token punctuation">)</span>dataTask didReceiveData<span class="token punctuation">:</span><span class="token punctuation">(</span>NSData <span class="token operator">*</span><span class="token punctuation">)</span>data <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token keyword">self</span> client<span class="token punctuation">]</span> URLProtocol<span class="token punctuation">:</span><span class="token keyword">self</span> didLoadData<span class="token punctuation">:</span>data<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>URLSession<span class="token punctuation">:</span><span class="token punctuation">(</span>NSURLSession <span class="token operator">*</span><span class="token punctuation">)</span>session task<span class="token punctuation">:</span><span class="token punctuation">(</span>NSURLSessionTask <span class="token operator">*</span><span class="token punctuation">)</span>task didCompleteWithError<span class="token punctuation">:</span><span class="token punctuation">(</span>nullable NSError <span class="token operator">*</span><span class="token punctuation">)</span>error <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>client URLProtocolDidFinishLoading<span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">@end</span></span></span></span></code></pre><div id="https://www.notion.so/6628c029b7754904acfebf2c41b8375b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div></article>  <footer class="Footer">
        <div>&copy; RadioHeadache 2019</div>
        <div>&centerdot;</div>
        <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
            rel="noopener noreferrer">Notablog</a>.
        </div>
    </footer>
</body>

</html>