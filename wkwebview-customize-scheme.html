<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- iOS Safari -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- Chrome, Firefox OS and Opera Status Bar Color -->
  <meta name="theme-color" content="#FFFFFF">
  <meta property="og:title" content="WKWebViewæ‹¦æˆªç‰¹å®šåŠ è½½åè®®">
    <meta name="description" content="é€šè¿‡ hook ç§æœ‰æ–¹æ³•æ¥è®© WKWebView è·å¾—æ‹¦æˆªç§æœ‰ scheme çš„èƒ½åŠ›">
  <meta property="og:description" content="é€šè¿‡ hook ç§æœ‰æ–¹æ³•æ¥è®© WKWebView è·å¾—æ‹¦æˆªç§æœ‰ scheme çš„èƒ½åŠ›">
    <meta property="og:type" content="blog">
  <title>WKWebViewæ‹¦æˆªç‰¹å®šåŠ è½½åè®®</title>
  <!-- Favicon -->
    <link rel="shortcut icon" href="ã€½ï¸">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
  <link rel="stylesheet" type="text/css"
    href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
  <link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
  <link rel="stylesheet" type="text/css" href="css/notablog.css">
  <link rel="stylesheet" type="text/css" href="css/theme.css">
  <style>
    :root {
      font-size: 18px;
    }

    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
    <a href="index.html">
      <div class="Navbar__Btn"><span>ã€½ï¸</span> <span>Home</span></div>
    </a>
                    <span class="Navbar__Delim">&centerdot;</span>
    <a href="iOS-Dev-Articles.html">
      <div class="Navbar__Btn"> <span>ğŸ“±iOS Articles</span></div>
    </a>
                                                                                                <span class="Navbar__Delim">&centerdot;</span>
    <a href="about.html">
      <div class="Navbar__Btn"><span>ğŸ˜€</span> <span>About</span></div>
    </a>
                          </nav>
  <header class="Header">
          <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
        <h1 class="Header__Title">WKWebViewæ‹¦æˆªç‰¹å®šåŠ è½½åè®®</h1>
            <div class="DateTagBar">
                <span class="DateTagBar__Item DateTagBar__Date">Posted on Fri, May 14, 2021</span>
                          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--red">
            <a href="tag/iOS-Dev.html">iOS-Dev</a>
          </span>
                <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--orange">
            <a href="tag/WKWebView.html">WKWebView</a>
          </span>
                  </div>
          </header>
      <article id="https://www.notion.so/35da67de128046aa9ef10e4d8152ed1c" class="PageRoot"><ul id="https://www.notion.so/344cc4de0ff442378a93c71f5de2edf2" class="ColorfulBlock ColorfulBlock--ColorGray TableOfContents"><li class="TableOfContents__Item"><a href="#https://www.notion.so/5bcbf5e1da934bf6aaba61e5d583fbeb"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">After iOS 11 - WKURLSchemeHandler</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/9e701989be0447efbf1701e2cde8c9e1"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">1. è®¾å®š handler</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/cddf01aaf8e04d0d8cb4a1110d8274f1"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">2. override å›è°ƒï¼Œé€šè¿‡NSURLResponseè¿”å›Data</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/ef81de3648e54f6899550e701c83cba5"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">iOS 10 and below</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/9013815cd09741ffa40411ba8b5bdb03"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">æŠ€æœ¯èƒŒæ™¯</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/2a76c8075d1e4512a72ff6398b6d5ec1"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">æ–¹æ¡ˆæ¥æº</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/938fd55176144528b6e57c83c2e0bda1"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">å®ç°æ–¹æ¡ˆ</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/3cac55933c8144fc8eb0e12557cdbcfa"><div style="margin-left:48px"><span class="SemanticStringArray"><span class="SemanticString">1. AppDelegateå†…æ³¨å†Œ</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/0b3e8c0f0e2c438b9e00e0c654abb1aa"><div style="margin-left:48px"><span class="SemanticStringArray"><span class="SemanticString">2. </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">InterceptionNSURLProtocol</code></span><span class="SemanticString"> ç±»</span></span></div></a></li></ul><h1 id="https://www.notion.so/5bcbf5e1da934bf6aaba61e5d583fbeb" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/5bcbf5e1da934bf6aaba61e5d583fbeb"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">After iOS 11 - WKURLSchemeHandler</span></span></h1><div id="https://www.notion.so/e717f6b1946d4edb98f64321c4c707b0" class="Bookmark"><a href="https://developer.apple.com/videos/play/wwdc2017/220/"><h5 class="Bookmark__Title">Customized Loading in WKWebView - WWDC 2017 - Videos - Apple Developer</h5><p class="Bookmark__Desc">WKWebView allows you to seamlessly integrate web content into your app. Learn how new features in WKWebView allow you to manage cookies,...</p><p class="Bookmark__Link">https://developer.apple.com/videos/play/wwdc2017/220/</p></a></div><div id="https://www.notion.so/e2305ea1a12644bb89a368f1dd3f277f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">iOS 11 ä¹‹åï¼Œè‹¹æœä¸º WKWebView æ¨å‡º WKURLSchemeHandler çš„å›è°ƒæ–¹æ³•ï¼Œåœ¨ web è¯·æ±‚èµ„æºçš„æ—¶å€™ï¼Œå¦‚æœä½¿ç”¨äº† non-standard éæ­£å¼çš„ schemeï¼Œéƒ½å¯ä»¥è¢«æ‹¦æˆªï¼Œå¹¶é€šè¿‡å›è°ƒé€šçŸ¥ã€‚</span></span></p></div><h2 id="https://www.notion.so/9e701989be0447efbf1701e2cde8c9e1" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/9e701989be0447efbf1701e2cde8c9e1"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">1. è®¾å®š handler</span></span></h2><pre id="https://www.notion.so/de3cb33c9a82476aaf42cf283835025a" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token operator">-</span> <span class="token punctuation">(</span>WKWebView <span class="token operator">*</span><span class="token punctuation">)</span>webView <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_webView <span class="token operator">==</span> nil<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        WKWebViewConfiguration <span class="token operator">*</span>configuration <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>WKWebViewConfiguration alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">@</span><span class="token function">available</span><span class="token punctuation">(</span>iOS <span class="token number">11.0</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            </span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedBg SemanticString__Fragment--BgPink"><span><span class="token punctuation">[</span>configuration setURLSchemeHandler<span class="token punctuation">:</span><span class="token keyword">self</span> forURLScheme<span class="token punctuation">:</span><span class="token string">@"img"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</span></mark></span><span class="SemanticString"><span>						</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedBg SemanticString__Fragment--BgPink"><span><span class="token comment">// è®¾å®šè‡ªå®šä¹‰çš„ scheme</span></span></mark></span><span class="SemanticString"><span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// Fallback on earlier versions</span>
        <span class="token punctuation">}</span>
        _webView <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>WKWebView alloc<span class="token punctuation">]</span> initWithFrame<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>view frame<span class="token punctuation">]</span> configuration<span class="token punctuation">:</span>configuration<span class="token punctuation">]</span><span class="token punctuation">;</span>
        _webView<span class="token punctuation">.</span>navigationDelegate <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">;</span>
        _webView<span class="token punctuation">.</span>UIDelegate <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> _webView<span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></span></span></code></pre><h2 id="https://www.notion.so/cddf01aaf8e04d0d8cb4a1110d8274f1" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/cddf01aaf8e04d0d8cb4a1110d8274f1"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">2. override å›è°ƒï¼Œé€šè¿‡NSURLResponseè¿”å›Data</span></span></h2><pre id="https://www.notion.so/21a3541f74ab427ab5cc8080ef32ad0d" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">mark <span class="token operator">-</span> WKURLSchemeHandler</span></span>

<span class="token comment">/*! @abstract Notifies your app to start loading the data for a particular resource
 represented by the URL scheme handler task.
 @param webView The web view invoking the method.
 @param urlSchemeTask The task that your app should start loading data for.
 */</span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>webView<span class="token punctuation">:</span><span class="token punctuation">(</span>WKWebView <span class="token operator">*</span><span class="token punctuation">)</span>webView startURLSchemeTask<span class="token punctuation">:</span><span class="token punctuation">(</span>id <span class="token operator">&lt;</span>WKURLSchemeTask<span class="token operator">></span><span class="token punctuation">)</span>urlSchemeTask  <span class="token function">API_AVAILABLE</span><span class="token punctuation">(</span><span class="token function">ios</span><span class="token punctuation">(</span><span class="token number">11.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    NSURL <span class="token operator">*</span>requestURL <span class="token operator">=</span> urlSchemeTask<span class="token punctuation">.</span>request<span class="token punctuation">.</span>URL<span class="token punctuation">;</span>
    NSString <span class="token operator">*</span>filter <span class="token operator">=</span> <span class="token punctuation">[</span>NSString stringWithFormat<span class="token punctuation">:</span><span class="token string">@"img"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span>requestURL<span class="token punctuation">.</span>absoluteString containsString<span class="token punctuation">:</span>filter<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    UIImage <span class="token operator">*</span>image <span class="token operator">=</span> <span class="token punctuation">[</span>UIImage imageNamed<span class="token punctuation">:</span>requestURL<span class="token punctuation">.</span>lastPathComponent<span class="token punctuation">]</span><span class="token punctuation">;</span>
    NSData <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token function">UIImageJPEGRepresentation</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    NSURLResponse <span class="token operator">*</span>response <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSURLResponse alloc<span class="token punctuation">]</span> initWithURL<span class="token punctuation">:</span>urlSchemeTask<span class="token punctuation">.</span>request<span class="token punctuation">.</span>URL MIMEType<span class="token punctuation">:</span><span class="token string">@"image/jpeg"</span> expectedContentLength<span class="token punctuation">:</span>data<span class="token punctuation">.</span>length textEncodingName<span class="token punctuation">:</span>nil<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>urlSchemeTask didReceiveResponse<span class="token punctuation">:</span>response<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>urlSchemeTask didReceiveData<span class="token punctuation">:</span>data<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>urlSchemeTask didFinish<span class="token punctuation">]</span><span class="token punctuation">;</span>    
<span class="token punctuation">}</span>

<span class="token comment">/*! @abstract Notifies your app to stop handling a URL scheme handler task.
 @param webView The web view invoking the method.
 @param urlSchemeTask The task that your app should stop handling.
 @discussion After your app is told to stop loading data for a URL scheme handler task
 it must not perform any callbacks for that task.
 An exception will be thrown if any callbacks are made on the URL scheme handler task
 after your app has been told to stop loading for it.
 */</span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>webView<span class="token punctuation">:</span><span class="token punctuation">(</span>WKWebView <span class="token operator">*</span><span class="token punctuation">)</span>webView stopURLSchemeTask<span class="token punctuation">:</span><span class="token punctuation">(</span>id <span class="token operator">&lt;</span>WKURLSchemeTask<span class="token operator">></span><span class="token punctuation">)</span>urlSchemeTask  <span class="token function">API_AVAILABLE</span><span class="token punctuation">(</span><span class="token function">ios</span><span class="token punctuation">(</span><span class="token number">11.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
<span class="token punctuation">}</span></span></span></span></code></pre><h1 id="https://www.notion.so/ef81de3648e54f6899550e701c83cba5" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/ef81de3648e54f6899550e701c83cba5"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">iOS 10 and below</span></span></h1><h2 id="https://www.notion.so/9013815cd09741ffa40411ba8b5bdb03" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/9013815cd09741ffa40411ba8b5bdb03"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">æŠ€æœ¯èƒŒæ™¯</span></span></h2><div id="https://www.notion.so/73b4d6d4bb2e4356bc24b94bb1143e86" class="Bookmark"><a href="https://www.jianshu.com/p/55f5ac1ab817"><h5 class="Bookmark__Title">WKWebView ä¸æ”¯æŒ NSURLProtocol å—</h5><p class="Bookmark__Desc">å‰æ®µæ—¶é—´æ€»ç»“è¿‡ã€ŠWKWebViewä»å…¥é—¨åˆ°è¶Ÿå‘ã€‹ï¼Œå…¶ä¸­æåˆ° NSURLProtocol æ‹¦æˆªæ”¯æŒå’Œç¼“å­˜çš„ç—›ç‚¹ã€‚åœ¨ UIWebView æ—¶ä»£ï¼ŒæŒ‰ç…§ä¸‹é¢çš„æ–¹å¼æ³¨å†Œä¸€ä¸ªè‡ªå®šä¹‰çš„ NSURLProtocol å’Œ CustomURLCache çš„å­ç±»ï¼Œ // æ³¨å†Œurlæ‹¦æˆª [NSURLProtocol registerClass:[CustomURLProtocol class]]; // æ³¨å†Œç¼“å­˜åŠ è½½ [NSURLCache setSharedURLCache:[CustomURLCache new]]; ç„¶åå°±å¯ä»¥åœ¨å…¶å®ç°ä¸­å¯¹ app å†…æ‰€æœ‰çš„ç½‘ç»œè¯·æ±‚è¿›è¡Œæ‹¦æˆªï¼Œå¹¶åŠ è½½æœ¬åœ°çš„ç¦»çº¿èµ„æºï¼ˆå¾ˆå¤š Hybird æ¡†æ¶éƒ½æ˜¯åŸºäºæ­¤åŸç†ï¼‰ã€‚ä½†åœ¨ WKWebView ä¸­çš„è¯·æ±‚å´å®Œå…¨ä¸éµä»è¿™ä¸€è§„åˆ™ï¼Œç½‘ç»œä¸Šæ–‡ç« ä¸€èˆ¬éƒ½è§£é‡Šè¯´ WKWebView çš„è¯·æ±‚æ˜¯åœ¨å•ç‹¬çš„è¿›ç¨‹é‡Œï¼Œæ‰€ä»¥ä¸èµ° NSURLProtocolã€‚ æ–­ç‚¹è°ƒç”¨æ ˆä¹Ÿæ˜¾ç¤º WKWebView åœ¨åŠ è½½ page æ—¶å€™çš„ç¡®ä½¿ç”¨çš„æ˜¯ WebKit çš„ IPC æ¶ˆæ¯æ”¶å‘/åˆ†å‘æœºåˆ¶ MessageQueue è¿›è¡Œè¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ï¼Œä½†ä¹Ÿå‘ç°å®ƒç«Ÿç„¶è°ƒç”¨åˆ°äº† + [NSURLProtocol canInitWithRequest:] ä¹‹åçš„æµç¨‹å°±ä¸åœ¨æ‰§è¡Œ NSURLProtocol ç›¸å…³çš„æ–¹æ³•äº†ï¼Œæ—¢ç„¶è°ƒç”¨äº†ä¸€ä¸ª canInitWithRequestï¼Œè‡³å°‘è¯´æ˜ WKWebView è¿˜æ˜¯å¼•ç”¨äº† NSURLProtocol</p><p class="Bookmark__Link">https://www.jianshu.com/p/55f5ac1ab817</p></a></div><div id="https://www.notion.so/2f90e4ee02a54540a08e8433b9d62a16" class="Bookmark"><a href="https://zhuanlan.zhihu.com/p/24990222"><h5 class="Bookmark__Title">WKWebView é‚£äº›å‘</h5><p class="Bookmark__Desc">æœ¬æ–‡æ¥è‡ªäº è…¾è®¯Buglyå…¬ä¼—å·ï¼ˆweixinBuglyï¼‰ï¼Œæœªç»ä½œè€…åŒæ„ï¼Œè¯·å‹¿è½¬è½½ï¼ŒåŸæ–‡åœ°å€ï¼šWKWebView é‚£äº›å‘ å¯¼è¯­ WKWebView æ˜¯è‹¹æœåœ¨ WWDC 2014 ä¸Šæ¨å‡ºçš„æ–°ä¸€ä»£ webView ç»„ä»¶ï¼Œç”¨ä»¥æ›¿ä»£ UIKit ä¸­ç¬¨é‡éš¾ç”¨ã€å†…å­˜æ³„æ¼çš„ UIW...</p><p class="Bookmark__Link">https://zhuanlan.zhihu.com/p/24990222</p></a></div><div id="https://www.notion.so/d32b7e1533c74c2cbd7c19b37e187a3d" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">ğŸ’¡</div></div><p class="Callout__Content"><span class="SemanticStringArray"><span class="SemanticString">WKWebView åœ¨ç‹¬ç«‹äº app è¿›ç¨‹ä¹‹å¤–çš„è¿›ç¨‹ä¸­æ‰§è¡Œç½‘ç»œè¯·æ±‚ï¼Œè¯·æ±‚æ•°æ®ä¸ç»è¿‡ä¸»è¿›ç¨‹ï¼Œå› æ­¤ï¼Œåœ¨ WKWebView ä¸Šç›´æ¥ä½¿ç”¨ NSURLProtocol æ— æ³•æ‹¦æˆªè¯·æ±‚ã€‚</span></span></p></div><h2 id="https://www.notion.so/2a76c8075d1e4512a72ff6398b6d5ec1" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/2a76c8075d1e4512a72ff6398b6d5ec1"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">æ–¹æ¡ˆæ¥æº</span></span></h2><div id="https://www.notion.so/3b9072391d374ff8b512ca72a3b7883d" class="Bookmark"><a href="https://github.com/LiuShuoyu/HybirdWKWebVIew"><h5 class="Bookmark__Title">LiuShuoyu/HybirdWKWebVIew</h5><p class="Bookmark__Desc">ä¸€ä¸ªåŸºäºWKWebViewçš„hybirdeçš„å®¹å™¨ã€‚èƒ½æ‹¦æˆªæ‰€æœ‰WKWKWebViewçš„çš„css,js,pngç­‰ç½‘ç»œè¯·æ±‚çš„demo NSURLProtocol å­ç±»ï¼Œå°±å¯ä»¥å¯¹ app å†…æ‰€æœ‰çš„ç½‘ç»œè¯·æ±‚è¿›è¡Œ: å¯æ˜¯åœ¨ WKWebView ä¸­çš„è¯·æ±‚å´å®Œå…¨ä¸éµä»è¿™ä¸€è§„åˆ™ï¼Œåªæ˜¯è±¡å¾æ€§+ (BOOL) canInitWithRequest:(NSURLRequest *)request æ–¹æ³•ï¼Œä¹‹åçš„æ•´ä¸ªè¯·æ±‚æµç¨‹ä¼¼ä¹å°±ä¸ NSURLProtocol å®Œå…¨æ— å…³äº†ã€‚ ä½¿æˆ‘WKWebView çš„ä¸€åº¦è®¤ä¸ºè¯·æ±‚ä¸éµå®ˆNSURLProtocolåè®®ï¼Œæ‰€ä»¥ä¸èµ° NSURLProtocolã€‚è¿™ä¸ªä¹Ÿæ˜¯å¾ˆè‹¦æ‰°æˆ‘çš„é—®é¢˜ã€‚å¯¼è‡´æˆ‘ä»¬hybirdçš„å®¹å™¨1.0ä¹Ÿæ˜¯æ˜¯ç”¨UIWebVIewå®ç°çš„ã€‚ ä½†åœ¨è‹¹æœæ”¾åœ¨gittubçš„CustomHTTPProtocolï¼Œæ˜æ˜¾æ„Ÿè§‰åˆ°WKWebviewçš„ä¹Ÿæ˜¯éµå®ˆNSURLProtocolï¼Œè¦ä¸ä¹Ÿä¸ä¼šèµ°+ (BOOL)canInitWithRequest:(NSURLRequest *)request;åæ¥ä¸€ä¸ªæ¯å¤©çœ‹åšå®¢å’Œgittubçš„ä¹ æƒ¯å¸®åŠ©äº†æˆ‘ï¼Œæ‰¾åˆ°ä¸€ä¸ªå¤§ç¥çš„ä¸ä¹…å‰å¼€æºåº“ã€‚ ä½¿ç”¨äº†WKBrowsingContextControllerå’ŒregisterSchemeForCustomProtocolã€‚ é€šè¿‡åå°„çš„æ–¹å¼æ‹¿åˆ°äº†ç§æœ‰çš„ class/selectorã€‚é€šè¿‡kvcå–åˆ°browsingContextControllerã€‚é€šè¿‡æŠŠæ³¨å†ŒæŠŠ http å’Œ https è¯·æ±‚äº¤ç»™ NSURLProtocol å¤„ç† ä¸‹é¢ç›´æ¥ä¸Šæºä»£ç å§ æ³¨å†Œåï¼Œå®¢æˆ·ç«¯æ‰€æœ‰è¯·æ±‚èµ°+ (BOOL)canInitWithRequest:(NSURLRequest *)requestã€‚ä¸‹é¢æ˜¯æ‰“å°çš„è¯·æ±‚çš„log requestçš„é‡å†™å®šå‘ï¼Œrequestçš„é‡å†™å®šå‘ï¼Œæ›¿æ¢ç™¾åº¦çŸ¥é“çš„log è¿™é‡Œæœ€å¥½åŠ ä¸Šç¼“å­˜åˆ¤æ–­ï¼ŒåŠ è½½æœ¬åœ°ç¦»çº¿æ–‡ä»¶ï¼Œ è¿™ä¸ªç›´æ¥ç®€å•çš„ä¾‹å­ã€‚ ä¸‹é¢æ˜¯ä»£ç æ•ˆæœå›¾ ##æœ‰é—®é¢˜åé¦ˆ åœ¨ä½¿ç”¨ä¸­æœ‰ä»»ä½•é—®é¢˜ï¼Œæ¬¢è¿åé¦ˆç»™æˆ‘ï¼Œå¯ä»¥ç”¨ä»¥ä¸‹è”ç³»æ–¹å¼è·Ÿæˆ‘äº¤æµ ###æ¥å—å¯å‘çš„ä½œè€…çš„github githubï¼š Yeatse CC è‹¹æœå¼€å‘è€…æ–‡æ¡£ï¼š apple</p><p class="Bookmark__Link">https://github.com/LiuShuoyu/HybirdWKWebVIew</p></a></div><div id="https://www.notion.so/159e14fd0db3443b990ee1c10a1cd52a" class="Bookmark"><a href="https://github.com/madaoCN/WKWebViewHook"><h5 class="Bookmark__Title">madaoCN/WKWebViewHook</h5><p class="Bookmark__Desc">hook WKWebViewHook request with NSURLProtocol. Contribute to madaoCN/WKWebViewHook development by creating an account on GitHub.</p><p class="Bookmark__Link">https://github.com/madaoCN/WKWebViewHook</p></a></div><h2 id="https://www.notion.so/938fd55176144528b6e57c83c2e0bda1" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/938fd55176144528b6e57c83c2e0bda1"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">å®ç°æ–¹æ¡ˆ</span></span></h2><h3 id="https://www.notion.so/3cac55933c8144fc8eb0e12557cdbcfa" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/3cac55933c8144fc8eb0e12557cdbcfa"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">1. AppDelegateå†…æ³¨å†Œ</span></span></h3><pre id="https://www.notion.so/bb4c6e2d46eb430088c84b6a1a0e4815" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token operator">-</span> <span class="token punctuation">(</span>BOOL<span class="token punctuation">)</span>application<span class="token punctuation">:</span><span class="token punctuation">(</span>UIApplication <span class="token operator">*</span><span class="token punctuation">)</span>application didFinishLaunchingWithOptions<span class="token punctuation">:</span><span class="token punctuation">(</span>NSDictionary <span class="token operator">*</span><span class="token punctuation">)</span>launchOptions <span class="token punctuation">{</span>
	<span class="token comment">// é˜²æ­¢è‹¹æœé™æ€æ£€æŸ¥ å°† WKBrowsingContextController æ‹†åˆ†ï¼Œç„¶åå†æ‹¼å‡‘èµ·æ¥</span>
	NSArray <span class="token operator">*</span>privateStrArr <span class="token operator">=</span> <span class="token operator">@</span><span class="token punctuation">[</span><span class="token string">@"Controller"</span><span class="token punctuation">,</span> <span class="token string">@"Context"</span><span class="token punctuation">,</span> <span class="token string">@"Browsing"</span><span class="token punctuation">,</span> <span class="token string">@"K"</span><span class="token punctuation">,</span> <span class="token string">@"W"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	NSString <span class="token operator">*</span>className <span class="token operator">=</span>  <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">[</span>privateStrArr reverseObjectEnumerator<span class="token punctuation">]</span> allObjects<span class="token punctuation">]</span> componentsJoinedByString<span class="token punctuation">:</span><span class="token string">@""</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	Class cls <span class="token operator">=</span> <span class="token function">NSClassFromString</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
	SEL sel <span class="token operator">=</span> <span class="token function">NSSelectorFromString</span><span class="token punctuation">(</span><span class="token string">@"registerSchemeForCustomProtocol:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">if</span> <span class="token punctuation">(</span>cls <span class="token operator">&amp;&amp;</span> sel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>cls respondsToSelector<span class="token punctuation">:</span>sel<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	        <span class="token comment">// æ³¨å†Œhttpåè®®</span>
	<span class="token comment">//                [(id)cls performSelector:sel withObject:@"http"];</span>
	        <span class="token comment">// æ³¨å†Œhttpsåè®®</span>
	<span class="token comment">//                [(id)cls performSelector:sel withObject:@"https"];</span>
	        <span class="token comment">// æ³¨å†Œ img åè®®</span>
	        <span class="token punctuation">[</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>cls performSelector<span class="token punctuation">:</span>sel withObject<span class="token punctuation">:</span><span class="token string">@"img"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token punctuation">[</span>NSURLProtocol registerClass<span class="token punctuation">:</span><span class="token punctuation">[</span>InterceptionNSURLProtocol class<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></span></span></code></pre><h3 id="https://www.notion.so/0b3e8c0f0e2c438b9e00e0c654abb1aa" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/0b3e8c0f0e2c438b9e00e0c654abb1aa"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">2. </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">InterceptionNSURLProtocol</code></span><span class="SemanticString"> ç±»</span></span></h3><pre id="https://www.notion.so/4b562ae7de0140a3a9df585f8b0d98a8" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">import</span> <span class="token string">"InterceptionNSURLProtocol.h"</span></span>

<span class="token keyword">static</span> NSString<span class="token operator">*</span> <span class="token keyword">const</span> KHybridNSURLProtocolHKey <span class="token operator">=</span> <span class="token string">@"KHybridNSURLProtocol"</span><span class="token punctuation">;</span>

<span class="token keyword">@interface</span> <span class="token function">InterceptionNSURLProtocol</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span>NSURLSessionDelegate<span class="token operator">></span>
<span class="token keyword">@property</span> <span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> strong<span class="token punctuation">)</span> NSURLSessionDataTask <span class="token operator">*</span>task<span class="token punctuation">;</span>
<span class="token keyword">@end</span>

<span class="token keyword">@implementation</span> InterceptionNSURLProtocol
<span class="token operator">+</span> <span class="token punctuation">(</span>BOOL<span class="token punctuation">)</span>canInitWithRequest<span class="token punctuation">:</span><span class="token punctuation">(</span>NSURLRequest <span class="token operator">*</span><span class="token punctuation">)</span>request <span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@"request.URL.absoluteString = %@"</span><span class="token punctuation">,</span>request<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>absoluteString<span class="token punctuation">)</span><span class="token punctuation">;</span>
    NSString <span class="token operator">*</span>scheme <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>request URL<span class="token punctuation">]</span> scheme<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token comment">// è¿›è¡Œæ‹¦æˆªçš„åˆ¤æ–­</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>scheme caseInsensitiveCompare<span class="token punctuation">:</span><span class="token string">@"img"</span><span class="token punctuation">]</span>  <span class="token operator">==</span> NSOrderedSame<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//çœ‹çœ‹æ˜¯å¦å·²ç»å¤„ç†è¿‡äº†ï¼Œé˜²æ­¢æ— é™å¾ªç¯</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>NSURLProtocol propertyForKey<span class="token punctuation">:</span>KHybridNSURLProtocolHKey inRequest<span class="token punctuation">:</span>request<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> NO<span class="token punctuation">;</span>
        <span class="token keyword">return</span> YES<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> NO<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">+</span> <span class="token punctuation">(</span>NSURLRequest <span class="token operator">*</span><span class="token punctuation">)</span>canonicalRequestForRequest<span class="token punctuation">:</span><span class="token punctuation">(</span>NSURLRequest <span class="token operator">*</span><span class="token punctuation">)</span>request
<span class="token punctuation">{</span>
    NSMutableURLRequest <span class="token operator">*</span>mutableReqeust <span class="token operator">=</span> <span class="token punctuation">[</span>request mutableCopy<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token comment">//requestæˆªå–é‡å®šå‘</span>
<span class="token comment">//    if ([request.URL.absoluteString isEqualToString:sourUrl])</span>
<span class="token comment">//    {</span>
<span class="token comment">//        NSURL* url1 = [NSURL URLWithString:localUrl];</span>
<span class="token comment">//        mutableReqeust = [NSMutableURLRequest requestWithURL:url1];</span>
<span class="token comment">//    }</span>
    
    <span class="token keyword">return</span> mutableReqeust<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">+</span> <span class="token punctuation">(</span>BOOL<span class="token punctuation">)</span>requestIsCacheEquivalent<span class="token punctuation">:</span><span class="token punctuation">(</span>NSURLRequest <span class="token operator">*</span><span class="token punctuation">)</span>a toRequest<span class="token punctuation">:</span><span class="token punctuation">(</span>NSURLRequest <span class="token operator">*</span><span class="token punctuation">)</span>b
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token keyword">super</span> requestIsCacheEquivalent<span class="token punctuation">:</span>a toRequest<span class="token punctuation">:</span>b<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>startLoading
<span class="token punctuation">{</span>
    NSMutableURLRequest <span class="token operator">*</span>mutableReqeust <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token keyword">self</span> request<span class="token punctuation">]</span> mutableCopy<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//ç»™æˆ‘ä»¬å¤„ç†è¿‡çš„è¯·æ±‚è®¾ç½®ä¸€ä¸ªæ ‡è¯†ç¬¦, é˜²æ­¢æ— é™å¾ªç¯,</span>
    <span class="token punctuation">[</span>NSURLProtocol setProperty<span class="token punctuation">:</span><span class="token operator">@</span>YES forKey<span class="token punctuation">:</span>KHybridNSURLProtocolHKey inRequest<span class="token punctuation">:</span>mutableReqeust<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token comment">//è¿™é‡Œæœ€å¥½åŠ ä¸Šç¼“å­˜åˆ¤æ–­ï¼ŒåŠ è½½æœ¬åœ°ç¦»çº¿æ–‡ä»¶ï¼Œ è¿™ä¸ªç›´æ¥ç®€å•çš„ä¾‹å­ã€‚</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>mutableReqeust<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>absoluteString isEqualToString<span class="token punctuation">:</span><span class="token operator">@</span>"img<span class="token punctuation">:</span><span class="token comment">//123123"])</span>
    <span class="token punctuation">{</span>
            NSData<span class="token operator">*</span> data <span class="token operator">=</span> <span class="token function">UIImagePNGRepresentation</span><span class="token punctuation">(</span><span class="token punctuation">[</span>UIImage imageNamed<span class="token punctuation">:</span><span class="token string">@"icon"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            NSURLResponse<span class="token operator">*</span> response <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSURLResponse alloc<span class="token punctuation">]</span> initWithURL<span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">.</span>request<span class="token punctuation">.</span>URL MIMEType<span class="token punctuation">:</span><span class="token string">@"image/png"</span> expectedContentLength<span class="token punctuation">:</span>data<span class="token punctuation">.</span>length textEncodingName<span class="token punctuation">:</span>nil<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>client URLProtocol<span class="token punctuation">:</span><span class="token keyword">self</span> didReceiveResponse<span class="token punctuation">:</span>response cacheStoragePolicy<span class="token punctuation">:</span>NSURLCacheStorageAllowed<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>client URLProtocol<span class="token punctuation">:</span><span class="token keyword">self</span> didLoadData<span class="token punctuation">:</span>data<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>client URLProtocolDidFinishLoading<span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        NSURLSession <span class="token operator">*</span>session <span class="token operator">=</span> <span class="token punctuation">[</span>NSURLSession sessionWithConfiguration<span class="token punctuation">:</span><span class="token punctuation">[</span>NSURLSessionConfiguration defaultSessionConfiguration<span class="token punctuation">]</span> delegate<span class="token punctuation">:</span><span class="token keyword">self</span> delegateQueue<span class="token punctuation">:</span>nil<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>task <span class="token operator">=</span> <span class="token punctuation">[</span>session dataTaskWithRequest<span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">.</span>request<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>task resume<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>stopLoading
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>task <span class="token operator">!=</span> nil<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>task  cancel<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>URLSession<span class="token punctuation">:</span><span class="token punctuation">(</span>NSURLSession <span class="token operator">*</span><span class="token punctuation">)</span>session dataTask<span class="token punctuation">:</span><span class="token punctuation">(</span>NSURLSessionDataTask <span class="token operator">*</span><span class="token punctuation">)</span>dataTask didReceiveResponse<span class="token punctuation">:</span><span class="token punctuation">(</span>NSURLResponse <span class="token operator">*</span><span class="token punctuation">)</span>response completionHandler<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>NSURLSessionResponseDisposition<span class="token punctuation">)</span><span class="token punctuation">)</span>completionHandler <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token keyword">self</span> client<span class="token punctuation">]</span> URLProtocol<span class="token punctuation">:</span><span class="token keyword">self</span> didReceiveResponse<span class="token punctuation">:</span>response cacheStoragePolicy<span class="token punctuation">:</span>NSURLCacheStorageAllowed<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token function">completionHandler</span><span class="token punctuation">(</span>NSURLSessionResponseAllow<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>URLSession<span class="token punctuation">:</span><span class="token punctuation">(</span>NSURLSession <span class="token operator">*</span><span class="token punctuation">)</span>session dataTask<span class="token punctuation">:</span><span class="token punctuation">(</span>NSURLSessionDataTask <span class="token operator">*</span><span class="token punctuation">)</span>dataTask didReceiveData<span class="token punctuation">:</span><span class="token punctuation">(</span>NSData <span class="token operator">*</span><span class="token punctuation">)</span>data <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token keyword">self</span> client<span class="token punctuation">]</span> URLProtocol<span class="token punctuation">:</span><span class="token keyword">self</span> didLoadData<span class="token punctuation">:</span>data<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>URLSession<span class="token punctuation">:</span><span class="token punctuation">(</span>NSURLSession <span class="token operator">*</span><span class="token punctuation">)</span>session task<span class="token punctuation">:</span><span class="token punctuation">(</span>NSURLSessionTask <span class="token operator">*</span><span class="token punctuation">)</span>task didCompleteWithError<span class="token punctuation">:</span><span class="token punctuation">(</span>nullable NSError <span class="token operator">*</span><span class="token punctuation">)</span>error <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>client URLProtocolDidFinishLoading<span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">@end</span></span></span></span></code></pre><div id="https://www.notion.so/6628c029b7754904acfebf2c41b8375b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div></article>  <footer class="Footer">
        <div>&copy; RadioHeadache 2019</div>
        <div>&centerdot;</div>
        <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
            rel="noopener noreferrer">Notablog</a>.
        </div>
    </footer>
</body>

</html>