<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- iOS Safari -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- Chrome, Firefox OS and Opera Status Bar Color -->
  <meta name="theme-color" content="#FFFFFF">
  <meta property="og:title" content="WKWebView æ— æ³•é•¿æˆªå›¾çš„é—®é¢˜">
    <meta property="og:type" content="blog">
  <title>WKWebView æ— æ³•é•¿æˆªå›¾çš„é—®é¢˜</title>
  <!-- Favicon -->
    <link rel="shortcut icon" href="ğŸŒ«ï¸">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
  <link rel="stylesheet" type="text/css"
    href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
  <link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
  <link rel="stylesheet" type="text/css" href="css/notablog.css">
  <link rel="stylesheet" type="text/css" href="css/theme.css">
  <style>
    :root {
      font-size: 18px;
    }

    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
    <a href="index.html">
      <div class="Navbar__Btn"><span>ğŸŒ«ï¸</span> <span>Home</span></div>
    </a>
                                            <span class="Navbar__Delim">&centerdot;</span>
    <a href="iOS-Dev-Articles.html">
      <div class="Navbar__Btn"> <span>ğŸ“±iOS Articles</span></div>
    </a>
                                                                                                <span class="Navbar__Delim">&centerdot;</span>
    <a href="about.html">
      <div class="Navbar__Btn"><span>ğŸ˜€</span> <span>About</span></div>
    </a>
                                <span class="Navbar__Delim">&centerdot;</span>
    <a href="newsletter.html">
      <div class="Navbar__Btn"><span>ğŸ“Ÿ</span> <span>Newsletter</span></div>
    </a>
          </nav>
  <header class="Header">
          <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
        <h1 class="Header__Title">WKWebView æ— æ³•é•¿æˆªå›¾çš„é—®é¢˜</h1>
            <div class="DateTagBar">
                <span class="DateTagBar__Item DateTagBar__Date">Posted on Wed, Feb 27, 2019</span>
                          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--red">
            <a href="tag/iOS-Dev.html">iOS-Dev</a>
          </span>
                <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--orange">
            <a href="tag/WKWebView.html">WKWebView</a>
          </span>
                  </div>
          </header>
      <article id="https://www.notion.so/1d57919543af45e2b983fcac955f5c58" class="PageRoot"><h1 id="https://www.notion.so/6b9fb7403bf24f7e83cca89dfb716a30" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/6b9fb7403bf24f7e83cca89dfb716a30"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">WKWebview æ— æ³•é•¿æˆªå›¾çš„é—®é¢˜</span></span></h1><div id="https://www.notion.so/3d291eebe2954c8a9b4f8d046c890be6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">æ–‡ç« æ›¾å‘å¸ƒäºç®€ä¹¦ï¼š</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://www.jianshu.com/p/7ad6e404a46b">https://www.jianshu.com/p/7ad6e404a46b</a></span></span></p></div><div id="https://www.notion.so/8459c620bf7b48c2a615d155b36ff302" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">å› ä¸ºä¸šåŠ¡éœ€æ±‚ï¼Œè¦åšä¸€ä¸ªé•¿æˆªå›¾çš„åŠŸèƒ½ï¼Œåˆå› ä¸ºé¡¹ç›®æ˜¯åŸºäº</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">WKWebview</code></span><span class="SemanticString">å¼€å‘çš„é¡¹ç›®ï¼Œæ‰€ä»¥é•¿æˆªå›¾çš„éœ€æ±‚å°±å˜æˆäº†å¯¹</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">WKWebview</code></span><span class="SemanticString">è¿›è¡Œé•¿æˆªå›¾ã€‚</span></span></p></div><div id="https://www.notion.so/882abdfb00ff49b9b61dd3edafa35257" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">åœ¨ç½‘ä¸Šæœç´¢äº†ä¸€ç•ªï¼Œå‘ç°äº†ä¸€å¥—é•¿æˆªå›¾çš„é€»è¾‘ï¼Œå¦‚ä¸‹ï¼š</span></span></p></div><pre id="https://www.notion.so/7974e55c2fb84cc1bad57339cb29ea9f" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>snapshotForWKWebView<span class="token punctuation">:</span><span class="token punctuation">(</span>WKWebView <span class="token operator">*</span><span class="token punctuation">)</span>webView CaptureCompletionHandler<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">)</span><span class="token punctuation">(</span>UIImage <span class="token operator">*</span>capturedImage<span class="token punctuation">)</span><span class="token punctuation">)</span>completionHandler
<span class="token punctuation">{</span>
    <span class="token comment">// 1.ä¸ºäº†æˆªå›¾æ—¶å¯¹ frame è¿›è¡Œæ“ä½œä¸ä¼šå‡ºç°é—ªå±ç­‰ç°è±¡ï¼Œæˆ‘ä»¬éœ€è¦ç›–ä¸€ä¸ªâ€œå‡â€çš„ webView åˆ°ç°åœ¨çš„ä½ç½®ä¸Šï¼Œå¹¶å°†çœŸæ­£çš„ webView â€œæ‘˜ä¸‹æ¥â€ã€‚è°ƒç”¨ snapshotViewAfterScreenUpdates å³å¯å¾—åˆ°è¿™æ ·ä¸€ä¸ªâ€œå‡â€çš„ webView</span>
    UIView <span class="token operator">*</span>snapshotView <span class="token operator">=</span> <span class="token punctuation">[</span>webView snapshotViewAfterScreenUpdates<span class="token punctuation">:</span>YES<span class="token punctuation">]</span><span class="token punctuation">;</span>
    snapshotView<span class="token punctuation">.</span>frame <span class="token operator">=</span> webView<span class="token punctuation">.</span>frame<span class="token punctuation">;</span>
    <span class="token punctuation">[</span>webView<span class="token punctuation">.</span>superview addSubview<span class="token punctuation">:</span>snapshotView<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 2. ä¿å­˜çœŸæ­£çš„ webView çš„åç§»ã€ä½ç½®ç­‰ä¿¡æ¯ï¼Œä»¥ä¾¿æˆªå›¾å®Œæˆä¹‹åâ€œè¿˜åŸç°åœºâ€</span>
    CGPoint currentOffset <span class="token operator">=</span> webView<span class="token punctuation">.</span>scrollView<span class="token punctuation">.</span>contentOffset<span class="token punctuation">;</span>
    CGRect currentFrame <span class="token operator">=</span> webView<span class="token punctuation">.</span>frame<span class="token punctuation">;</span>
    UIView <span class="token operator">*</span>currentSuperView <span class="token operator">=</span> webView<span class="token punctuation">.</span>superview<span class="token punctuation">;</span>
    NSUInteger currentIndex <span class="token operator">=</span> <span class="token punctuation">[</span>webView<span class="token punctuation">.</span>superview<span class="token punctuation">.</span>subviews indexOfObject<span class="token punctuation">:</span>webView<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. ç”¨ä¸€ä¸ªæ–°çš„è§†å›¾æ‰¿è½½â€œçœŸæ­£çš„â€ webViewï¼Œè¿™ä¸ªè§†å›¾ä¹Ÿæ˜¯ç»˜å›¾æ‰€ç”¨åˆ°çš„ä¸Šä¸‹æ–‡</span>
    UIView <span class="token operator">*</span>containerView <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>UIView alloc<span class="token punctuation">]</span> initWithFrame<span class="token punctuation">:</span>webView<span class="token punctuation">.</span>bounds<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>webView removeFromSuperview<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>containerView addSubview<span class="token punctuation">:</span>webView<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 4. å°† webView æŒ‰ç…§å®é™…å†…å®¹é«˜åº¦å’Œå±å¹•é«˜åº¦åˆ†æˆ page é¡µ</span>
    CGSize totalSize <span class="token operator">=</span> webView<span class="token punctuation">.</span>scrollView<span class="token punctuation">.</span>contentSize<span class="token punctuation">;</span>
    NSInteger page <span class="token operator">=</span> <span class="token function">ceil</span><span class="token punctuation">(</span>totalSize<span class="token punctuation">.</span>height <span class="token operator">/</span> containerView<span class="token punctuation">.</span>bounds<span class="token punctuation">.</span>size<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>

    webView<span class="token punctuation">.</span>scrollView<span class="token punctuation">.</span>contentOffset <span class="token operator">=</span> CGPointZero<span class="token punctuation">;</span>
    webView<span class="token punctuation">.</span>frame <span class="token operator">=</span> <span class="token function">CGRectMake</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> containerView<span class="token punctuation">.</span>bounds<span class="token punctuation">.</span>size<span class="token punctuation">.</span>width<span class="token punctuation">,</span> webView<span class="token punctuation">.</span>scrollView<span class="token punctuation">.</span>contentSize<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">UIGraphicsBeginImageContextWithOptions</span><span class="token punctuation">(</span>totalSize<span class="token punctuation">,</span> YES<span class="token punctuation">,</span> UIScreen<span class="token punctuation">.</span>mainScreen<span class="token punctuation">.</span>scale<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span><span class="token keyword">self</span> drawContentPage<span class="token punctuation">:</span>containerView webView<span class="token punctuation">:</span>webView index<span class="token punctuation">:</span><span class="token number">0</span> maxIndex<span class="token punctuation">:</span>page completion<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">{</span>
        UIImage <span class="token operator">*</span>snapshotImage <span class="token operator">=</span> <span class="token function">UIGraphicsGetImageFromCurrentImageContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">UIGraphicsEndImageContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">[</span>webView removeFromSuperview<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span>currentSuperView insertSubview<span class="token punctuation">:</span>webView atIndex<span class="token punctuation">:</span>currentIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
        webView<span class="token punctuation">.</span>frame <span class="token operator">=</span> currentFrame<span class="token punctuation">;</span>
        webView<span class="token punctuation">.</span>scrollView<span class="token punctuation">.</span>contentOffset <span class="token operator">=</span> currentOffset<span class="token punctuation">;</span>

        <span class="token comment">// 8. è°ƒç”¨ UIGraphicsGetImageFromCurrentImageContext æ–¹æ³•ä»å½“å‰ä¸Šä¸‹æ–‡ä¸­è·å–åˆ°å®Œæ•´æˆªå›¾ï¼Œå°†ç¬¬ 2 æ­¥ä¸­ä¿å­˜çš„ä¿¡æ¯é‡æ–°èµ‹äºˆåˆ° webView ä¸Šï¼Œâ€œè¿˜åŸç°åœºâ€</span>
        <span class="token punctuation">[</span>snapshotView removeFromSuperview<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token function">completionHandler</span><span class="token punctuation">(</span>snapshotImage<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>drawContentPage<span class="token punctuation">:</span><span class="token punctuation">(</span>UIView <span class="token operator">*</span><span class="token punctuation">)</span>targetView webView<span class="token punctuation">:</span><span class="token punctuation">(</span>WKWebView <span class="token operator">*</span><span class="token punctuation">)</span>webView index<span class="token punctuation">:</span><span class="token punctuation">(</span>NSInteger<span class="token punctuation">)</span>index maxIndex<span class="token punctuation">:</span><span class="token punctuation">(</span>NSInteger<span class="token punctuation">)</span>maxIndex completion<span class="token punctuation">:</span><span class="token punctuation">(</span>dispatch_block_t<span class="token punctuation">)</span>completion
<span class="token punctuation">{</span>
    <span class="token comment">// 5. å¾—åˆ°æ¯ä¸€é¡µçš„å®é™…ä½ç½®ï¼Œå¹¶å°† webView å¾€ä¸Šæ¨åˆ°è¯¥ä½ç½®</span>
    CGRect splitFrame <span class="token operator">=</span> <span class="token function">CGRectMake</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> index <span class="token operator">*</span> <span class="token function">CGRectGetHeight</span><span class="token punctuation">(</span>targetView<span class="token punctuation">.</span>bounds<span class="token punctuation">)</span><span class="token punctuation">,</span> targetView<span class="token punctuation">.</span>bounds<span class="token punctuation">.</span>size<span class="token punctuation">.</span>width<span class="token punctuation">,</span> targetView<span class="token punctuation">.</span>frame<span class="token punctuation">.</span>size<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CGRect myFrame <span class="token operator">=</span> webView<span class="token punctuation">.</span>frame<span class="token punctuation">;</span>
    myFrame<span class="token punctuation">.</span>origin<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token operator">-</span><span class="token punctuation">(</span>index <span class="token operator">*</span> targetView<span class="token punctuation">.</span>frame<span class="token punctuation">.</span>size<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    webView<span class="token punctuation">.</span>frame <span class="token operator">=</span> myFrame<span class="token punctuation">;</span>

    <span class="token function">dispatch_after</span><span class="token punctuation">(</span><span class="token function">dispatch_time</span><span class="token punctuation">(</span>DISPATCH_TIME_NOW<span class="token punctuation">,</span> <span class="token punctuation">(</span>int64_t<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0.1</span> <span class="token operator">*</span> NSEC_PER_SEC<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">dispatch_get_main_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token comment">// 6. è°ƒç”¨ drawViewHierarchyInRect å°†å½“å‰ä½ç½®çš„ webView æ¸²æŸ“åˆ°ä¸Šä¸‹æ–‡ä¸­</span>
        <span class="token punctuation">[</span>targetView drawViewHierarchyInRect<span class="token punctuation">:</span>splitFrame afterScreenUpdates<span class="token punctuation">:</span>YES<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// 7. å¦‚æœè¿˜æœªåˆ°è¾¾æœ€åä¸€é¡µï¼Œåˆ™é€’å½’è°ƒç”¨ drawViewHierarchyInRect æ–¹æ³•è¿›è¡Œæ¸²æŸ“ï¼›å¦‚æœå·²ç»æ¸²æŸ“å®Œäº†å…¨éƒ¨é¡µï¼Œåˆ™å›è°ƒé€šçŸ¥æˆªå›¾å®Œæˆ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> maxIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">[</span><span class="token keyword">self</span> drawContentPage<span class="token punctuation">:</span>targetView webView<span class="token punctuation">:</span>webView index<span class="token punctuation">:</span>index <span class="token operator">+</span> <span class="token number">1</span> maxIndex<span class="token punctuation">:</span>maxIndex completion<span class="token punctuation">:</span>completion<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">completion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></span></span></code></pre><div id="https://www.notion.so/b142bfd6a0894050af1120c2f4a3d980" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">è¿™å¥—æˆªå›¾ä»£ç ä¸€å®šè¦è·å–</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">webView.scrollView.contentSize</code></span><span class="SemanticString">ï¼Œä¹Ÿå°±æ˜¯é¡µé¢çš„æ€»é«˜åº¦ï¼Œä½†é¡¹ç›®å†…é¡µé¢ä½¿ç”¨çš„</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">framework7</code></span><span class="SemanticString">çš„cssé‡Œé¢å†™äº†</span></span></p></div><pre id="https://www.notion.so/94c3a2c17bcf4532b1d78e7051b0fd06" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token selector">body</span><span class="token punctuation">{</span>  <span class="token property">height</span> <span class="token punctuation">:</span> 100%<span class="token punctuation">;</span><span class="token punctuation">}</span></span></span></span></code></pre><div id="https://www.notion.so/fcefa39354484a58aa68bc3d7b1fdadd" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">å› æ­¤è·å–é¡µé¢çš„æ€»é«˜åº¦éƒ½æ˜¯ç­‰äºå±å¹•çš„é«˜åº¦ï¼Œå¯¼è‡´ä¸€ç›´æ— æ³•æˆªå›¾ï¼Œæˆ‘å°è¯•ç”¨KVOç›‘å¬ï¼Œä¹Ÿå°è¯•è¿‡</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">[self.webView evaluateJavaScript:@&quot;document.body.scrollHeight&quot;]</code></span><span class="SemanticString">ï¼Œæ‰€è·å–çš„é¡µé¢é«˜åº¦éƒ½ä¸€ç›´ç­‰äºå±å¹•é«˜åº¦ï¼Œè€Œä¸ç­‰äºé¡µé¢çš„å®é™…é«˜åº¦ã€‚å› æ­¤è¿™å¥—ä»£ç åœ¨æˆ‘çš„é¡¹ç›®ä¸Šæ— æ³•å®ç°é•¿æˆªå›¾ã€‚</span></span></p></div><div id="https://www.notion.so/73bdae81812c48809320edd8bb9e7c8d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div></article>  <footer class="Footer">
        <div>&copy; RadioHeadache 2019</div>
        <div>&centerdot;</div>
        <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
            rel="noopener noreferrer">Notablog</a>.
        </div>
    </footer>
</body>

</html>