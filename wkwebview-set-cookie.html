<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- iOS Safari -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- Chrome, Firefox OS and Opera Status Bar Color -->
  <meta name="theme-color" content="#FFFFFF">
  <meta property="og:title" content="WKWebView设置Cookie">
    <meta name="description" content="分别介绍了iOS11以上系统和11以下系统设置Cookie的方法">
  <meta property="og:description" content="分别介绍了iOS11以上系统和11以下系统设置Cookie的方法">
    <meta property="og:type" content="blog">
  <title>WKWebView设置Cookie</title>
  <!-- Favicon -->
    <link rel="shortcut icon" href="〽️">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
  <link rel="stylesheet" type="text/css"
    href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
  <link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
  <link rel="stylesheet" type="text/css" href="css/notablog.css">
  <link rel="stylesheet" type="text/css" href="css/theme.css">
  <style>
    :root {
      font-size: 18px;
    }

    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
    <a href="index.html">
      <div class="Navbar__Btn"><span>〽️</span> <span>Home</span></div>
    </a>
                            <span class="Navbar__Delim">&centerdot;</span>
    <a href="iOS-Dev-Articles.html">
      <div class="Navbar__Btn"> <span>📱iOS Articles</span></div>
    </a>
                                                                                                <span class="Navbar__Delim">&centerdot;</span>
    <a href="about.html">
      <div class="Navbar__Btn"><span>😀</span> <span>About</span></div>
    </a>
                          </nav>
  <header class="Header">
          <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
        <h1 class="Header__Title">WKWebView设置Cookie</h1>
            <div class="DateTagBar">
                <span class="DateTagBar__Item DateTagBar__Date">Posted on Mon, May 24, 2021</span>
                          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--red">
            <a href="tag/iOS-Dev.html">iOS-Dev</a>
          </span>
                <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--orange">
            <a href="tag/WKWebView.html">WKWebView</a>
          </span>
                  </div>
          </header>
      <article id="https://www.notion.so/6bae241d48c546f3885b1a207f4c1a8c" class="PageRoot"><ul id="https://www.notion.so/1ae99d0c80ff4209af6030c9da23c72b" class="ColorfulBlock ColorfulBlock--ColorGray TableOfContents"><li class="TableOfContents__Item"><a href="#https://www.notion.so/5eba312cc19c431194dee6dbbb43491e"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">iOS 11 and Later</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/50b707ebd96a443a96e0d919bd3e05ab"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">iOS 10 and Below</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/9125920a9aa64dc2ae7f5a0ed07d40d4"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">加载请求</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/894f70429dd0442dbdaff0be29e838ec"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">插入cookie</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/b0305863d56f4095a1a41c32f67bf359"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">插入Cookie:</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">init</code></span><span class="SemanticString">方法，应对需要cookie才能加载资源的情景</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/307c94a1163a413091d0531a2ece753a"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">获取Cookie:回调，应对cookie的更新</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/b6fa919aa0414791936d9a9e0cc165e7"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">Tricky Part</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/f8825b734e864ca3a0b8a888d58c5280"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">延伸阅读</span></span></div></a></li></ul><h1 id="https://www.notion.so/5eba312cc19c431194dee6dbbb43491e" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/5eba312cc19c431194dee6dbbb43491e"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">iOS 11 and Later</span></span></h1><pre id="https://www.notion.so/4b9cb4b3745345a2a62855daa9d99eb2" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>NSString <span class="token operator">*</span>cookieString <span class="token operator">=</span> <span class="token string">@"SHRIOSESSIONID=e863c201-613d-440a-964d-b5ad864fa465; auth_code=1477029363789178f78272114a086c76ea569; tif_wwlid=0b43bdd4e9b21178f782721ee2b9ac4b4b24e"</span><span class="token punctuation">;</span>
    NSArray<span class="token operator">&lt;</span>NSString<span class="token operator">*</span><span class="token operator">></span><span class="token operator">*</span> cookies <span class="token operator">=</span> <span class="token punctuation">[</span>cookieString componentsSeparatedByString<span class="token punctuation">:</span><span class="token string">@";"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>NSString <span class="token operator">*</span>cookie <span class="token keyword">in</span> cookies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        NSString <span class="token operator">*</span>cookieWithURL <span class="token operator">=</span> <span class="token punctuation">[</span>NSString stringWithFormat<span class="token punctuation">:</span><span class="token string">@"%@; ORIGINURL=%@"</span><span class="token punctuation">,</span> cookie<span class="token punctuation">,</span> <span class="token punctuation">[</span>NSURL URLWithString<span class="token punctuation">:</span><span class="token operator">@</span>"https<span class="token punctuation">:</span><span class="token comment">//xtbgsafe.gdzwfw.gov.cn/rstoa/instance-web/minstone/workflow/ipadFramePreview?readOnly=1&amp;flowId=2264&amp;stepCode=1&amp;flowInid=88779&amp;stepInco=101721&amp;dealIndx=0&amp;curPage=mark"]];</span>
        NSHTTPCookie<span class="token operator">*</span> httpCookie <span class="token operator">=</span> <span class="token punctuation">[</span>cookieWithURL cookie<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">[</span>NSHTTPCookieStorage sharedHTTPCookieStorage<span class="token punctuation">]</span> setCookie<span class="token punctuation">:</span>httpCookie<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">@</span><span class="token function">available</span><span class="token punctuation">(</span>iOS <span class="token number">11.0</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            WKHTTPCookieStore <span class="token operator">*</span>httpCookieStore <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>webView<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span>websiteDataStore<span class="token punctuation">.</span>httpCookieStore<span class="token punctuation">;</span>
            <span class="token punctuation">[</span>httpCookieStore setCookie<span class="token punctuation">:</span>httpCookie completionHandler<span class="token punctuation">:</span>nil<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// Fallback on earlier versions</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></span></span></span></code></pre><div id="https://www.notion.so/d46f3820f65a46a39d799982401e691b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">直接调用iOS 11之后的API，把cookie写入WKHTTPCookieStore里面</span></span></p></div><h1 id="https://www.notion.so/50b707ebd96a443a96e0d919bd3e05ab" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/50b707ebd96a443a96e0d919bd3e05ab"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">iOS 10 and Below</span></span></h1><div id="https://www.notion.so/354486b29c6b40b19d31c13ccd156aea" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">代码来源</span></span></p></div><div id="https://www.notion.so/7cb9057931d14275acfc70daf1d5eac8" class="Bookmark"><a href="https://github.com/haifengkao/YWebView"><h5 class="Bookmark__Title">haifengkao/YWebView</h5><p class="Bookmark__Desc">The primary codes are copied from an answer of SO. All cookies will be loaded from NSHTTPCookieStorage. When a web page is loaded, its cookies will be save to NSHTTPCookieStorage as well. This method allows cookie sharing among multiple WKWebView and UIWebView.</p><p class="Bookmark__Link">https://github.com/haifengkao/YWebView</p></a></div><div id="https://www.notion.so/833f14bd534f43ffa89aa0af12db54c4" class="Bookmark"><a href="https://stackoverflow.com/questions/26573137/can-i-set-the-cookies-to-be-used-by-a-wkwebview"><h5 class="Bookmark__Title">Can I set the cookies to be used by a WKWebView?</h5><p class="Bookmark__Desc">The reason behind posted this answer is I tried many solution but no one work properly, most of the answer not work in case where have to set cookie first time, and got result cookie not sync first time, Please use this solution it work for both iOS &gt;= 11.0 = 11.0 -- Swift 4.2 Get http cookies and set in wkwebview cookie store like this way, it&#x27;s very tricky point to load your request in wkwebview, must sent request for loading when cookies gonna be set completely, here is function that i wrote.</p><p class="Bookmark__Link">https://stackoverflow.com/questions/26573137/can-i-set-the-cookies-to-be-used-by-a-wkwebview</p></a></div><h2 id="https://www.notion.so/9125920a9aa64dc2ae7f5a0ed07d40d4" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/9125920a9aa64dc2ae7f5a0ed07d40d4"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">加载请求</span></span></h2><pre id="https://www.notion.so/b6cd7353ffba4673b83e82c542d77bc9" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token operator">-</span> <span class="token punctuation">(</span>WKNavigation<span class="token operator">*</span><span class="token punctuation">)</span>loadRequest<span class="token punctuation">:</span><span class="token punctuation">(</span>NSURLRequest<span class="token operator">*</span><span class="token punctuation">)</span>originalRequest
<span class="token punctuation">{</span>
    NSString <span class="token operator">*</span>validDomain <span class="token operator">=</span> originalRequest<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>host<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>validDomain<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// hasSuffix requires non-nil string</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token keyword">super</span> loadRequest<span class="token punctuation">:</span>originalRequest<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 

    NSMutableURLRequest <span class="token operator">*</span>request <span class="token operator">=</span> <span class="token punctuation">[</span>originalRequest mutableCopy<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> BOOL requestIsSecure <span class="token operator">=</span> <span class="token punctuation">[</span>request<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>scheme isEqualToString<span class="token punctuation">:</span><span class="token string">@"https"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    NSMutableArray <span class="token operator">*</span>array <span class="token operator">=</span> <span class="token punctuation">[</span>NSMutableArray array<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>NSHTTPCookie <span class="token operator">*</span>cookie <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSHTTPCookieStorage sharedHTTPCookieStorage<span class="token punctuation">]</span> cookies<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Don't even bother with values containing a `'`</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>cookie<span class="token punctuation">.</span>name rangeOfString<span class="token punctuation">:</span><span class="token string">@"'"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>location <span class="token operator">!=</span> NSNotFound<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//NSLog(@"Skipping %@ because it contains a '", cookie.properties);</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Is the cookie for current domain?</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span>validDomain hasSuffix<span class="token punctuation">:</span>cookie<span class="token punctuation">.</span>domain<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">[</span>cookie<span class="token punctuation">.</span>domain hasSuffix<span class="token punctuation">:</span>validDomain<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//NSLog(@"Skipping %@ (because not %@)", cookie.properties, validDomain);</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Are we secure only?</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cookie<span class="token punctuation">.</span>secure <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>requestIsSecure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//NSLog(@"Skipping %@ (because %@ not secure)", cookie.properties, request.URL.absoluteString);</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        NSString <span class="token operator">*</span>value <span class="token operator">=</span> <span class="token punctuation">[</span>NSString stringWithFormat<span class="token punctuation">:</span><span class="token string">@"%@=%@"</span><span class="token punctuation">,</span> cookie<span class="token punctuation">.</span>name<span class="token punctuation">,</span> cookie<span class="token punctuation">.</span>value<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span>array addObject<span class="token punctuation">:</span>value<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    NSString <span class="token operator">*</span>header <span class="token operator">=</span> <span class="token punctuation">[</span>array componentsJoinedByString<span class="token punctuation">:</span><span class="token string">@";"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>request setValue<span class="token punctuation">:</span>header forHTTPHeaderField<span class="token punctuation">:</span><span class="token string">@"Cookie"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token keyword">super</span> loadRequest<span class="token punctuation">:</span>request<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></span></span></code></pre><div id="https://www.notion.so/5b677c5e69ca457b8433b62838312437" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">YWebView重写了</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">loadRequest</code></span><span class="SemanticString">方法，将存储在</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">NSHTTPCookieStorage</code></span><span class="SemanticString">里的cookie拿出来，拼接成</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">NSString</code></span><span class="SemanticString">，并通过</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">[request setValue:header forHTTPHeaderField:@&quot;Cookie&quot;];</code></span><span class="SemanticString">将cookie写入请求头中。</span></span></p></div><div id="https://www.notion.so/0677cbf2b9f8416996f7176023544557" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">此时如果打印</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">request.allHTTPHeaderFields</code></span><span class="SemanticString">，可以看到写入的cookie：</span></span></p></div><pre id="https://www.notion.so/eb1edc2de6f64847ab96637f2e5c9ad5" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>(lldb) po request.allHTTPHeaderFields
{
    Cookie = &quot;SHRIOSESSIONID=eb0ca63a-135d-4a7c-a2d3-d0ffbb35e6eb;tif_wwlid=07ef94a892ce9179981dea8b6cf5f1e7f9347;auth_code=037ac592a235a179981dea76b2e0d6edb360c&quot;;
}</span></span></span></code></pre><div id="https://www.notion.so/b2f0239a0e294d5b96cdd199619cadb2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">为了实现上面的结果，需要在webView加载请求之前先将cookie写入</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">NSHTTPCookieStorage</code></span><span class="SemanticString">内。</span></span></p></div><h2 id="https://www.notion.so/894f70429dd0442dbdaff0be29e838ec" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/894f70429dd0442dbdaff0be29e838ec"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">插入cookie</span></span></h2><pre id="https://www.notion.so/b05854c224c94e538259bb89f07c1dfc" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token operator">-</span> <span class="token punctuation">(</span>instancetype<span class="token punctuation">)</span>initWithFrame<span class="token punctuation">:</span><span class="token punctuation">(</span>CGRect<span class="token punctuation">)</span>frame configuration<span class="token punctuation">:</span><span class="token punctuation">(</span>WKWebViewConfiguration<span class="token operator">*</span><span class="token punctuation">)</span>theConfiguration
<span class="token punctuation">{</span>
    YMessageHandler<span class="token operator">*</span> handler <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>YMessageHandler alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>

    WKWebViewConfiguration<span class="token operator">*</span> configuration <span class="token operator">=</span> theConfiguration <span class="token operator">?</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>WKWebViewConfiguration alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
    WKUserContentController<span class="token operator">*</span> controller <span class="token operator">=</span> configuration<span class="token punctuation">.</span>userContentController <span class="token operator">?</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>WKUserContentController alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
    configuration<span class="token punctuation">.</span>userContentController <span class="token operator">=</span> controller<span class="token punctuation">;</span>

    <span class="token comment">// TODO: addCookieInScriptWithController should not put all cookies of all domains into the javascript</span>
    <span class="token comment">// BUT we don't know the correct domain unless the request has been loaded, what should we do?</span>
    </span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedBg SemanticString__Fragment--BgYellow"><span><span class="token punctuation">[</span>YWebView addCookieInScriptWithController<span class="token punctuation">:</span>controller<span class="token punctuation">]</span><span class="token punctuation">;</span></span></mark></span><span class="SemanticString"><span>
    
    </span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedBg SemanticString__Fragment--BgYellow"><span><span class="token punctuation">[</span>YWebView addCookieOutScriptWithController<span class="token punctuation">:</span>controller handler<span class="token punctuation">:</span>handler<span class="token punctuation">]</span><span class="token punctuation">;</span></span></mark></span><span class="SemanticString"><span> <span class="token comment">// will add Y_HANDLER_NAME here</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">self</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">super</span> initWithFrame<span class="token punctuation">:</span>frame configuration<span class="token punctuation">:</span>configuration<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _theConfiguration <span class="token operator">=</span> configuration<span class="token punctuation">;</span>
        _messageHandlerNames <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSMutableArray alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
        _messageHandler <span class="token operator">=</span> handler<span class="token punctuation">;</span>
        _messageHandler<span class="token punctuation">.</span>webView <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>navigationDelegate <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token keyword">self</span> addScriptMessageHandlerNameForCleanup<span class="token punctuation">:</span>Y_HANDLER_NAME<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></span></span></code></pre><div id="https://www.notion.so/973bb642088a48979f871171a3dc167e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">可以看到有两个</span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedBg SemanticString__Fragment--BgYellow">addCookieInScriptWithController</mark></span><span class="SemanticString">的方法，这两个方法分别代表了两个不同的处理cookie的方法，插入和更新。</span></span></p></div><h2 id="https://www.notion.so/b0305863d56f4095a1a41c32f67bf359" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/b0305863d56f4095a1a41c32f67bf359"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">插入Cookie:</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">init</code></span><span class="SemanticString">方法，应对需要cookie才能加载资源的情景</span></span></h2><pre id="https://www.notion.so/1d2bc586d12847e69d4a4fdcd548668c" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>addCookieInScriptWithController<span class="token punctuation">:</span><span class="token punctuation">(</span>WKUserContentController<span class="token operator">*</span><span class="token punctuation">)</span>userContentController
<span class="token punctuation">{</span>
    NSMutableString<span class="token operator">*</span> script <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSMutableString alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// Get the currently set cookie names in javascriptland</span>
    <span class="token punctuation">[</span>script appendString<span class="token punctuation">:</span><span class="token string">@"var cookieNames = document.cookie.split('; ').map(function(cookie) { return cookie.split('=')[0] } );\n"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>NSHTTPCookie <span class="token operator">*</span>cookie <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>NSHTTPCookieStorage sharedHTTPCookieStorage<span class="token punctuation">]</span> cookies<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Skip cookies that will break our script</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>cookie<span class="token punctuation">.</span>value rangeOfString<span class="token punctuation">:</span><span class="token string">@"'"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>location <span class="token operator">!=</span> NSNotFound<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Create a line that appends this cookie to the web view's document's cookies</span>
        <span class="token punctuation">[</span>script appendFormat<span class="token punctuation">:</span><span class="token string">@"if (cookieNames.indexOf('%@') == -1) { document.cookie='%@'; };\n"</span><span class="token punctuation">,</span> cookie<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">self</span> </span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedBg SemanticString__Fragment--BgBlue"><span>javascriptStringWithCookie<span class="token punctuation">:</span>cookie</span></mark></span><span class="SemanticString"><span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    WKUserScript <span class="token operator">*</span>cookieInScript <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>WKUserScript alloc<span class="token punctuation">]</span> initWithSource<span class="token punctuation">:</span>script
                                                          injectionTime<span class="token punctuation">:</span>WKUserScriptInjectionTimeAtDocumentStart
                                                       forMainFrameOnly<span class="token punctuation">:</span>NO<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>userContentController addUserScript<span class="token punctuation">:</span>cookieInScript<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">+</span> <span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span></span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedBg SemanticString__Fragment--BgBlue"><span>javascriptStringWithCookie</span></mark></span><span class="SemanticString"><span><span class="token punctuation">:</span><span class="token punctuation">(</span>NSHTTPCookie<span class="token operator">*</span><span class="token punctuation">)</span>cookie <span class="token punctuation">{</span>
    
    NSString <span class="token operator">*</span>string <span class="token operator">=</span> <span class="token punctuation">[</span>NSString stringWithFormat<span class="token punctuation">:</span><span class="token string">@"%@=%@;domain=%@;path=%@"</span><span class="token punctuation">,</span>
                        cookie<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
                        cookie<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
                        cookie<span class="token punctuation">.</span>domain<span class="token punctuation">,</span>
                        cookie<span class="token punctuation">.</span>path <span class="token operator">?</span><span class="token punctuation">:</span> <span class="token string">@"/"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cookie<span class="token punctuation">.</span>secure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        string <span class="token operator">=</span> <span class="token punctuation">[</span>string stringByAppendingString<span class="token punctuation">:</span><span class="token string">@";secure=true"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@"cookie string: --- %@ ---"</span><span class="token punctuation">,</span> string<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> string<span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></span></span></code></pre><div id="https://www.notion.so/0748abd9adeb4de68bad821ad10b21f7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">这个方法在webView的init方法里执行，inject插入cookie的js代码，执行时机是</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">WKUserScriptInjectionTimeAtDocumentStart</code></span><span class="SemanticString">，根据文档可知道：</span></span></p></div><div id="https://www.notion.so/62f82321a7a341bea2a6b98a5fbb3923" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">💡</div></div><p class="Callout__Content"><span class="SemanticStringArray"><span class="SemanticString">@constant WKUserScriptInjectionTimeAtDocumentStart -</span><span class="SemanticString"><span class="SemanticString__Fragment SemanticString__Fragment--Unknown"> Inject the script after the document element has been created, but before any other content has been loaded.</span></span></span></p></div><h2 id="https://www.notion.so/307c94a1163a413091d0531a2ece753a" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/307c94a1163a413091d0531a2ece753a"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">获取Cookie:回调，应对cookie的更新</span></span></h2><pre id="https://www.notion.so/3ed542d86b0e484fafbb2fad0bae90fb" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>addCookieOutScriptWithController<span class="token punctuation">:</span><span class="token punctuation">(</span>WKUserContentController<span class="token operator">*</span><span class="token punctuation">)</span>userContentController handler<span class="token punctuation">:</span><span class="token punctuation">(</span>id<span class="token operator">&lt;</span>WKScriptMessageHandler<span class="token operator">></span><span class="token punctuation">)</span>handler
<span class="token punctuation">{</span>
    WKUserScript <span class="token operator">*</span>cookieOutScript <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>WKUserScript alloc<span class="token punctuation">]</span> initWithSource<span class="token punctuation">:</span><span class="token string">@"window.webkit.messageHandlers."</span> Y_HANDLER_NAME <span class="token string">@".postMessage(document.cookie);"</span>
                                                           injectionTime<span class="token punctuation">:</span>WKUserScriptInjectionTimeAtDocumentStart
                                                        forMainFrameOnly<span class="token punctuation">:</span>NO<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>userContentController addUserScript<span class="token punctuation">:</span>cookieOutScript<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span>userContentController addScriptMessageHandler<span class="token punctuation">:</span>handler
                                              name<span class="token punctuation">:</span>Y_HANDLER_NAME<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></span></span></code></pre><div id="https://www.notion.so/61bbefc5ec864b89b9ad167b16aafe53" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">这里插入的JS代码为：</span></span></p></div><pre id="https://www.notion.so/d635b46f52dc4f5f92486901eb0f3fbe" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>window<span class="token punctuation">.</span>webkit<span class="token punctuation">.</span>messageHandlers<span class="token punctuation">.</span>y_updateCookies<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span></span></span></span></code></pre><div id="https://www.notion.so/3162c48ce85042aca5ec4814a90a2bee" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">⚠️由于这里调用的是</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">document.cookie</code></span><span class="SemanticString">，因此无法获取到HTTPOnly的cookie。</span></span></p></div><div id="https://www.notion.so/a17019dac00f48aab6f7b7dfe9b416d8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">YMessageHandler 类的代码：</span></span></p></div><pre id="https://www.notion.so/c31009296dce4dfd96e2b09a882ca624" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment">/** 
  * YMessageHandler deals with the script messages sent from cookieOutScript
  */</span>
<span class="token keyword">@interface</span> YMessageHandler <span class="token punctuation">:</span> NSObject<span class="token operator">&lt;</span>WKScriptMessageHandler<span class="token operator">></span>
<span class="token keyword">@property</span> <span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> weak<span class="token punctuation">)</span> WKWebView<span class="token operator">*</span> webView<span class="token punctuation">;</span>
<span class="token keyword">@end</span>

<span class="token keyword">@implementation</span> YMessageHandler

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">mark <span class="token operator">-</span> WKScriptMessageHandler</span></span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>userContentController<span class="token punctuation">:</span><span class="token punctuation">(</span>WKUserContentController <span class="token operator">*</span><span class="token punctuation">)</span>userContentController didReceiveScriptMessage<span class="token punctuation">:</span><span class="token punctuation">(</span>WKScriptMessage <span class="token operator">*</span><span class="token punctuation">)</span>message 
<span class="token punctuation">{</span>
    <span class="token function">NSAssert</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>webView<span class="token punctuation">,</span> <span class="token string">@"do you forget to set it?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    NSArray<span class="token operator">&lt;</span>NSString<span class="token operator">*</span><span class="token operator">></span><span class="token operator">*</span> cookies <span class="token operator">=</span> <span class="token punctuation">[</span>message<span class="token punctuation">.</span>body componentsSeparatedByString<span class="token punctuation">:</span><span class="token string">@"; "</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>NSString <span class="token operator">*</span>cookie <span class="token keyword">in</span> cookies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Get this cookie's name and value</span>
        NSArray<span class="token operator">&lt;</span>NSString <span class="token operator">*</span><span class="token operator">></span> <span class="token operator">*</span>comps <span class="token operator">=</span> <span class="token punctuation">[</span>cookie componentsSeparatedByString<span class="token punctuation">:</span><span class="token string">@"="</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>comps<span class="token punctuation">.</span>count <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// we need NSHTTPCookieOriginURL for NSHTTPCookie to be created</span>
        NSString<span class="token operator">*</span> cookieWithURL <span class="token operator">=</span> <span class="token punctuation">[</span>NSString stringWithFormat<span class="token punctuation">:</span><span class="token string">@"%@; ORIGINURL=%@"</span><span class="token punctuation">,</span> cookie<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>webView<span class="token punctuation">.</span>URL<span class="token punctuation">]</span><span class="token punctuation">;</span>
        NSHTTPCookie<span class="token operator">*</span> httpCookie <span class="token operator">=</span> <span class="token punctuation">[</span>cookieWithURL cookie<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>httpCookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">[</span><span class="token punctuation">[</span>NSHTTPCookieStorage sharedHTTPCookieStorage<span class="token punctuation">]</span> setCookie<span class="token punctuation">:</span>httpCookie<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">@end</span></span></span></span></code></pre><h2 id="https://www.notion.so/b6fa919aa0414791936d9a9e0cc165e7" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/b6fa919aa0414791936d9a9e0cc165e7"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Tricky Part</span></span></h2><div id="https://www.notion.so/d8afd26c1d9e428b8f6a80c0325047d9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">按照我找到的关于</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">WKUserContentController</code></span><span class="SemanticString">的教程，说的都是给</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">WKUserContentController</code></span><span class="SemanticString">添加一个</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">Handler</code></span><span class="SemanticString">，并且与前段约定</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">name</code></span><span class="SemanticString">字段。经过下面的代码，一个名为</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">jsToOc</code></span><span class="SemanticString">的handler就设定好了。</span></span></p></div><pre id="https://www.notion.so/1d028700e52945498ac4c09acb4274c6" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment">//! 为userContentController添加ScriptMessageHandler，并指明name</span>
WKUserContentController <span class="token operator">*</span>userContentController <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>WKUserContentController alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>userContentController addScriptMessageHandler<span class="token punctuation">:</span><span class="token keyword">self</span> name<span class="token punctuation">:</span><span class="token string">@"jsToOc"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">//! 使用添加了ScriptMessageHandler的userContentController配置configuration</span>
WKWebViewConfiguration <span class="token operator">*</span>configuration <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>WKWebViewConfiguration alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
configuration<span class="token punctuation">.</span>userContentController <span class="token operator">=</span> userContentController<span class="token punctuation">;</span>

<span class="token comment">//! 使用configuration对象初始化webView</span>
_webView <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>WKWebView alloc<span class="token punctuation">]</span> initWithFrame<span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span>bounds configuration<span class="token punctuation">:</span>configuration<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">mark <span class="token operator">-</span> WKScriptMessageHandler</span></span>

<span class="token comment">//! WKWebView收到ScriptMessage时回调此方法</span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>userContentController<span class="token punctuation">:</span><span class="token punctuation">(</span>WKUserContentController <span class="token operator">*</span><span class="token punctuation">)</span>userContentController didReceiveScriptMessage<span class="token punctuation">:</span><span class="token punctuation">(</span>WKScriptMessage <span class="token operator">*</span><span class="token punctuation">)</span>message <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>message<span class="token punctuation">.</span>name caseInsensitiveCompare<span class="token punctuation">:</span><span class="token string">@"jsToOc"</span><span class="token punctuation">]</span> <span class="token operator">==</span> NSOrderedSame<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">[</span>WKWebViewWKScriptMessageHandlerController showAlertWithTitle<span class="token punctuation">:</span>message<span class="token punctuation">.</span>name message<span class="token punctuation">:</span>message<span class="token punctuation">.</span>body cancelHandler<span class="token punctuation">:</span>nil<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></span></span></code></pre><div id="https://www.notion.so/06fa2420e65a44dfaaf19567a629f178" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">此时，前端调用下面的代码，让handler设定的didReceiveScriptMessage协议方法触发，实现JS与OC的联动：</span></span></p></div><pre id="https://www.notion.so/f22250e2e0b0447b9b1570eabc3bdbb6" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment">//! 登录成功</span>
function <span class="token function">loginSucceed</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  var action <span class="token operator">=</span> <span class="token string">"loginSucceed"</span><span class="token punctuation">;</span>
  window<span class="token punctuation">.</span>webkit<span class="token punctuation">.</span>messageHandlers<span class="token punctuation">.</span></span></span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold"><span>jsToOc</span></strong></span><span class="SemanticString"><span><span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span></span></code></pre><div id="https://www.notion.so/4d22ab578006433c9d7b08f999dc8b30" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">看代码可以发现，只要执行了</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">window.webkit.messageHandlers.&lt;name&gt;.postMessage(&lt;messageBody&gt;)</code></span><span class="SemanticString">，且name字段能对上，就能实现JS调用OC。</span></span></p></div><div id="https://www.notion.so/7fea63f9315a4993843bd72c35b92840" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">看到这里你就能明白，原本的逻辑是原生端埋好handler name以及回调方法，前端使用JS来触发方法。</span></span></p></div><div id="https://www.notion.so/be152a3410a54babaa09d22a9f8436c0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">可是上面的代码，已经把前端的调用代码和handler同时设置到</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">userContentController</code></span><span class="SemanticString">里面了：</span></span></p></div><pre id="https://www.notion.so/d91c12fee66f4eeb816dc2e82143f377" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>WKUserScript <span class="token operator">*</span>cookieOutScript <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>WKUserScript alloc<span class="token punctuation">]</span> initWithSource<span class="token punctuation">:</span><span class="token string">@"window.webkit.messageHandlers."</span> Y_HANDLER_NAME <span class="token string">@".postMessage(document.cookie);"</span>
                                                       injectionTime<span class="token punctuation">:</span>WKUserScriptInjectionTimeAtDocumentStart
                                                    forMainFrameOnly<span class="token punctuation">:</span>NO<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>userContentController addUserScript<span class="token punctuation">:</span>cookieOutScript<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>userContentController addScriptMessageHandler<span class="token punctuation">:</span>handler
                                          name<span class="token punctuation">:</span>Y_HANDLER_NAME<span class="token punctuation">]</span><span class="token punctuation">;</span></span></span></span></code></pre><div id="https://www.notion.so/7b095e637432479d9f6e4f2f200f3290" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">这意味着，根据</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">injectionTime:WKUserScriptInjectionTimeAtDocumentStart</code></span><span class="SemanticString">，每次页面载入/刷新，都会调用这个</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">cookieOutScript</code></span><span class="SemanticString">，把页面的cookie返回给原生，好让原生把最新的cookie保存到</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">NSHTTPCookieStorage</code></span><span class="SemanticString">内</span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">。</strong></span></span></p></div><h1 id="https://www.notion.so/f8825b734e864ca3a0b8a888d58c5280" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/f8825b734e864ca3a0b8a888d58c5280"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">延伸阅读</span></span></h1><div id="https://www.notion.so/707464dff5484e7084039d908b76b110" class="Bookmark"><a href="https://developer.apple.com/documentation/webkit/wkusercontentcontroller/1537172-addscriptmessagehandler?language=objc"><h5 class="Bookmark__Title">Apple Developer Documentation</h5><p class="Bookmark__Link">https://developer.apple.com/documentation/webkit/wkusercontentcontroller/1537172-addscriptmessagehandler?language=objc</p></a></div><div id="https://www.notion.so/8ceed92e988f40f4aa0d8452926bbb15" class="Bookmark"><a href="https://www.jianshu.com/p/905b40e609e2"><h5 class="Bookmark__Title">iOS与JS交互之WKWebView-WKScriptMessageHandler协议</h5><p class="Bookmark__Desc">级别：★★☆☆☆ 标签：「iOS与JS交互」「WKWebView与JS交互」「WKJSMessageHandler」 作者： Xs·H 审校： QiShare团队 先解释下标题：&quot;iOS与JS交互&quot;。iOS指 iOS原生代码（文章只有 OC示例），JS指 WEB前端（不单指 JavaScript），交互指 JS调用iOS和 iOS调用JS。 作者将iOS与JS交互总结成了6种方式，并将逐一介绍。目录如下： 本文介绍如果使用 WKWebView的 WKScriptMessageHandler实现 iOS与 JS交互。 WKWebView是 Apple在iOS8推出的 Webkit框架中的负责网页的渲染与展示的类，相比 UIWebView速度更快，占用内存更少，支持更多的 HTML特性。 WKScriptMessageHandler是 WebKit提供的一种在 WKWebView上进行 JS 消息控制的协议。 一、JS调用iOS： //! 登录 function login() { var token = &quot;js_tokenString&quot;; loginSucceed(token); } //! 登录成功 function loginSucceed(token) { var action = &quot;loginSucceed&quot;; window.webkit.messageHandlers.jsToOc.postMessage(action, token); } //!</p><p class="Bookmark__Link">https://www.jianshu.com/p/905b40e609e2</p></a></div><div id="https://www.notion.so/d5c05829bf134510a6740964e838dfbc" class="Bookmark"><a href="https://juejin.cn/post/6844903560686108679"><h5 class="Bookmark__Title">iOS WKWebView与JS交互</h5><p class="Bookmark__Desc">1.1 WKScriptMessageHandler协议 WKScriptMessageHandler其实就是一个遵循的协议，它能让网页通过JS把消息发送给OC。其中协议方法。 /*! @abstract Invoked when a script message is received from a webpage. @param userContentController The user content controller invoking the delegate method. @param message The script message received.</p><p class="Bookmark__Link">https://juejin.cn/post/6844903560686108679</p></a></div><div id="https://www.notion.so/578dcd5a76d14d31a2286b165917fcdc" class="Bookmark"><a href="https://www.fabrizioduroni.it/2019/08/03/html-javascript-to-native-communication-ios/"><h5 class="Bookmark__Title">Web to native code communication on iOS using WKScriptMessageHandler</h5><p class="Bookmark__Desc">Did you know that it is possible to call Swift code from the JavaScript code of a web page displayed inside a WKWebView? Sooner or later every mobile developer in the world had the following specific need: integrate a website page inside an app.</p><p class="Bookmark__Link">https://www.fabrizioduroni.it/2019/08/03/html-javascript-to-native-communication-ios/</p></a></div><div id="https://www.notion.so/fd2741acb1674d5e9b1040a8bf600b1f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div></article>  <footer class="Footer">
        <div>&copy; RadioHeadache 2019</div>
        <div>&centerdot;</div>
        <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
            rel="noopener noreferrer">Notablog</a>.
        </div>
    </footer>
</body>

</html>